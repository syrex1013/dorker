<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>THREATDORKER - Advanced Dashboard</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --bg-primary: #000000;
        --bg-secondary: #0a0a0a;
        --bg-tertiary: #1a1a1a;
        --text-primary: #ffffff;
        --text-secondary: #cccccc;
        --text-accent: #dc2626;
        --border-color: #333333;
        --success-color: #16a34a;
        --warning-color: #ea580c;
        --error-color: #dc2626;
        --glass-bg: rgba(0, 0, 0, 0.8);
        --shadow-sm: 0 1px 2px 0 rgb(220 38 38 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(220 38 38 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(220 38 38 / 0.1);
        --radius: 12px;
        --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        --accent-red: #dc2626;
        --accent-dark-red: #991b1b;
        --accent-light-red: #ef4444;
      }

      [data-theme="dark"] {
        --bg-primary: #0f172a;
        --bg-secondary: #1e293b;
        --bg-tertiary: #334155;
        --text-primary: #f8fafc;
        --text-secondary: #94a3b8;
        --text-accent: #60a5fa;
        --border-color: #334155;
        --glass-bg: rgba(15, 23, 42, 0.8);
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        overflow-x: hidden;
        min-height: 100vh;
        transition: var(--transition);
      }

      /* Header */
      .header {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--border-color);
        padding: 1rem 2rem;
        position: sticky;
        top: 0;
        z-index: 1000;
      }

      .header-content {
        max-width: 1600px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .logo h1 {
        font-size: 1.5rem;
        font-weight: 700;
        background: linear-gradient(
          135deg,
          var(--text-primary),
          var(--text-accent)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .header-controls {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .btn {
        padding: 0.5rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-primary);
        color: var(--text-primary);
        cursor: pointer;
        transition: var(--transition);
        font-size: 0.875rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn:hover {
        background: var(--bg-secondary);
        transform: translateY(-1px);
      }

      .btn-primary {
        background: var(--text-accent);
        color: white;
        border-color: var(--text-accent);
      }

      .detailed-status {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.25rem;
      }

      .status-pill {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        transition: all 0.3s ease;
      }

      .status-details {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-align: right;
        max-width: 200px;
        word-wrap: break-word;
        line-height: 1.2;
      }

      .status-idle {
        background: var(--bg-tertiary);
        color: var(--text-secondary);
      }

      .status-initializing {
        background: linear-gradient(45deg, #dc2626, #991b1b);
        color: white;
        animation: statusPulse 2s infinite;
      }

      .status-warming-up {
        background: linear-gradient(45deg, #ea580c, #c2410c);
        color: white;
        animation: statusPulse 1.5s infinite;
      }

      .status-searching {
        background: linear-gradient(45deg, #dc2626, #7f1d1d);
        color: white;
        animation: statusPulse 2s infinite;
      }

      .status-captcha {
        background: linear-gradient(45deg, #ef4444, #dc2626);
        color: white;
        animation: statusPulse 1s infinite;
      }

      .status-delaying-search {
        background: linear-gradient(45deg, #6b7280, #4b5563);
        color: white;
        animation: statusPulse 3s infinite;
      }

      .status-captcha-transcribing {
        background: linear-gradient(45deg, #dc2626, #7f1d1d);
        color: white;
        animation: statusPulse 1.5s infinite;
      }

      .status-running {
        background: var(--text-accent);
        color: white;
        animation: pulse 2s infinite;
      }

      .status-completed {
        background: var(--success-color);
        color: white;
      }

      .status-error {
        background: var(--error-color);
        color: white;
      }

      /* Main Layout */
      .container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 2rem;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .card {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        padding: 1.5rem;
        box-shadow: var(--shadow-sm);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
      }

      .card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .card-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .card-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        font-variant-numeric: tabular-nums;
      }

      .card-trend {
        font-size: 0.75rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.25rem;
      }

      .trend-up {
        color: var(--success-color);
      }

      .trend-down {
        color: var(--error-color);
      }

      /* Charts */
      .chart-container {
        position: relative;
        height: 200px;
        margin-top: 1rem;
      }

      /* Wide sections */
      .wide-section {
        grid-column: 1 / -1;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .section-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      /* Progress */
      .progress-ring {
        width: 60px;
        height: 60px;
        transform: rotate(-90deg);
      }

      .progress-ring-circle {
        fill: none;
        stroke: var(--bg-tertiary);
        stroke-width: 4;
      }

      .progress-ring-progress {
        fill: none;
        stroke: var(--text-accent);
        stroke-width: 4;
        stroke-linecap: round;
        transition: stroke-dasharray 0.5s ease;
      }

      /* Data table */
      .data-table {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        overflow: hidden;
      }

      .table-header {
        background: var(--bg-secondary);
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .table-content {
        max-height: 400px;
        overflow-y: auto;
        scroll-behavior: smooth;
        position: relative;
      }

      /* Infinite scroll enhancements */
      .infinite-scroll-loader {
        position: sticky;
        bottom: 0;
        background: var(--bg-primary);
        border-top: 1px solid var(--border-color);
        margin: 0;
        z-index: 1;
        backdrop-filter: blur(4px);
      }

      /* Custom scrollbars for infinite scroll containers */
      .table-content::-webkit-scrollbar {
        width: 8px;
      }

      .table-content::-webkit-scrollbar-track {
        background: var(--bg-secondary);
        border-radius: 4px;
      }

      .table-content::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 4px;
        transition: background 0.2s ease;
      }

      .table-content::-webkit-scrollbar-thumb:hover {
        background: var(--text-secondary);
      }

      /* Firefox scrollbar styling */
      .table-content {
        scrollbar-width: thin;
        scrollbar-color: var(--border-color) var(--bg-secondary);
      }

      .table-row {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        transition: var(--transition);
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        gap: 1rem;
      }

      .table-row:hover {
        background: var(--bg-secondary);
      }

      .table-row:last-child {
        border-bottom: none;
      }

      /* Notifications */
      .notification {
        position: fixed;
        top: 5rem;
        right: 2rem;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        padding: 1rem;
        box-shadow: var(--shadow-lg);
        max-width: 400px;
        z-index: 2000;
        transform: translateX(100%);
        transition: transform 0.3s ease;
      }

      .notification.show {
        transform: translateX(0);
      }

      .notification-success {
        border-left: 4px solid var(--success-color);
      }

      .notification-warning {
        border-left: 4px solid var(--warning-color);
      }

      .notification-error {
        border-left: 4px solid var(--error-color);
      }

      .notification-completion {
        border-left: 4px solid var(--success-color);
        background: linear-gradient(
          135deg,
          rgba(16, 185, 129, 0.1),
          rgba(16, 185, 129, 0.05)
        );
        border: 2px solid var(--success-color);
        box-shadow: 0 20px 40px rgba(16, 185, 129, 0.3);
        transform: translateX(100%) scale(0.9);
        max-width: 500px;
        z-index: 3000;
      }

      .notification-completion.show {
        transform: translateX(0) scale(1);
        animation: completionPulse 0.5s ease-out;
      }

      @keyframes completionPulse {
        0% {
          transform: translateX(0) scale(0.9);
        }
        50% {
          transform: translateX(0) scale(1.05);
        }
        100% {
          transform: translateX(0) scale(1);
        }
      }

      .completion-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.8);
        background: var(--bg-primary);
        border: 2px solid var(--success-color);
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 90vw;
        z-index: 5000;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transition: all 0.3s ease;
        text-align: center;
      }

      .completion-popup.show {
        opacity: 1;
        visibility: visible;
        pointer-events: all;
        transform: translate(-50%, -50%) scale(1);
      }

      .completion-popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
        z-index: 4000;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transition: opacity 0.3s ease, visibility 0.3s ease,
          pointer-events 0.3s ease;
      }

      .completion-popup-overlay.show {
        opacity: 1;
        visibility: visible;
        pointer-events: all;
      }

      .completion-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--success-color);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }

      .completion-message {
        font-size: 1rem;
        color: var(--text-primary);
        margin-bottom: 1.5rem;
        line-height: 1.5;
      }

      .completion-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: var(--bg-secondary);
        border-radius: 8px;
      }

      .completion-stat {
        text-align: center;
      }

      .completion-stat-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-accent);
      }

      .completion-stat-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 500;
      }

      .completion-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
      }

      /* Logs */
      .log-entry {
        font-family: "JetBrains Mono", monospace;
        font-size: 0.8rem;
        padding: 0.75rem;
        border-bottom: 1px solid var(--border-color);
        display: grid;
        grid-template-columns: auto auto 1fr;
        gap: 1rem;
        align-items: start;
      }

      .log-time {
        color: var(--text-secondary);
        font-weight: 500;
      }

      .log-level {
        padding: 0.125rem 0.5rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .log-level.info {
        background: var(--text-accent);
        color: white;
      }

      .log-level.success {
        background: var(--success-color);
        color: white;
      }

      .log-level.warning {
        background: var(--warning-color);
        color: white;
      }

      .log-level.error {
        background: var(--error-color);
        color: white;
      }

      .log-message {
        color: var(--text-primary);
        line-height: 1.4;
        word-break: break-word;
      }

      .important-log {
        background: var(--bg-secondary);
        border-left: 3px solid var(--text-accent);
      }

      .important-log .log-message {
        font-weight: 500;
      }

      /* Live Status Section */
      .status-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .main-status {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: var(--bg-secondary);
        border-radius: 12px;
        border: 2px solid var(--border-color);
      }

      .main-status-pill {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem 2rem;
        border-radius: 2rem;
        font-size: 1.1rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        transition: all 0.3s ease;
        min-width: 200px;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .main-status-pill i {
        font-size: 1.3rem;
      }

      .main-status-text {
        font-size: 1rem;
        color: var(--text-secondary);
        text-align: center;
        font-weight: 500;
      }

      .status-metrics {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        width: 100%;
      }

      .status-metric {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1rem;
        background: var(--bg-secondary);
        border-radius: 8px;
        border: 1px solid var(--border-color);
        transition: var(--transition);
      }

      .status-metric:hover {
        background: var(--bg-tertiary);
        transform: translateY(-2px);
      }

      .metric-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
        font-weight: 600;
      }

      .metric-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
        font-variant-numeric: tabular-nums;
      }

      /* Enhanced status pill variants */
      .main-status-pill.status-idle {
        background: linear-gradient(135deg, #6b7280, #9ca3af);
        color: white;
      }

      .main-status-pill.status-initializing {
        background: linear-gradient(135deg, #dc2626, #991b1b);
        color: white;
        animation: statusPulse 2s infinite;
      }

      .main-status-pill.status-warming-up {
        background: linear-gradient(135deg, #ea580c, #c2410c);
        color: white;
        animation: statusPulse 1.5s infinite;
      }

      .main-status-pill.status-searching {
        background: linear-gradient(135deg, #dc2626, #7f1d1d);
        color: white;
        animation: statusPulse 2s infinite;
      }

      .main-status-pill.status-captcha {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        animation: statusPulse 1s infinite;
      }

      .main-status-pill.status-captcha-proxy {
        background: linear-gradient(135deg, #ea580c, #c2410c);
        color: white;
        animation: statusPulse 0.8s infinite;
      }

      .main-status-pill.status-running {
        background: linear-gradient(135deg, #dc2626, #7f1d1d);
        color: white;
        animation: statusPulse 2s infinite;
      }

      .main-status-pill.status-completed {
        background: linear-gradient(135deg, #dc2626, #7f1d1d);
        color: white;
      }

      .main-status-pill.status-error {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
      }

      .main-status-pill.status-stopped {
        background: linear-gradient(135deg, #6b7280, #4b5563);
        color: white;
      }

      @media (max-width: 768px) {
        .status-metrics {
          grid-template-columns: 1fr;
        }

        .main-status-pill {
          min-width: 150px;
          padding: 0.75rem 1.5rem;
          font-size: 1rem;
        }
      }

      /* Results */
      .result-card {
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid var(--border-color);
      }

      .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
      }

      .result-dork {
        font-family: "JetBrains Mono", monospace;
        font-size: 0.875rem;
        color: var(--text-primary);
        word-break: break-all;
        flex: 1;
      }

      .result-count {
        background: var(--text-accent);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .result-urls {
        display: grid;
        gap: 0.5rem;
      }

      .result-url-container {
        background: var(--bg-primary);
        border-radius: 6px;
        border: 1px solid var(--border-color);
        padding: 0.75rem;
        transition: var(--transition);
      }

      .result-url-container:hover {
        background: var(--bg-tertiary);
        transform: translateX(4px);
      }

      .result-url-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
        word-break: break-word;
      }

      .result-url {
        color: var(--text-accent);
        text-decoration: none;
        font-size: 0.75rem;
        display: block;
        word-break: break-all;
        font-family: "JetBrains Mono", monospace;
        line-height: 1.4;
      }

      .result-url:hover {
        text-decoration: underline;
      }

      /* Animation */
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.8;
          transform: scale(1.05);
        }
      }

      /* Live stats animations */
      .live-update {
        animation: liveUpdate 0.5s ease-in-out;
      }

      @keyframes liveUpdate {
        0% {
          background-color: rgba(59, 130, 246, 0.1);
        }
        50% {
          background-color: rgba(59, 130, 246, 0.2);
        }
        100% {
          background-color: transparent;
        }
      }

      .status-pulse {
        animation: statusPulse 2s infinite;
      }

      @keyframes statusPulse {
        0%,
        100% {
          box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4);
        }
        50% {
          box-shadow: 0 0 0 8px rgba(34, 197, 94, 0);
        }
      }

      .live-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--success-color);
        font-size: 0.75rem;
        font-weight: 600;
      }

      .live-dot {
        width: 6px;
        height: 6px;
        background: var(--success-color);
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      /* Modal */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 3000;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transition: opacity 0.3s ease, visibility 0.3s ease,
          pointer-events 0.3s ease;
      }

      .modal.show {
        opacity: 1;
        visibility: visible;
        pointer-events: all;
      }

      .modal-content {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        padding: 2rem;
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: var(--shadow-lg);
        transform: scale(0.95);
        transition: var(--transition);
        position: relative;
        z-index: 3001;
      }

      .modal.show .modal-content {
        transform: scale(1);
      }

      .modal-header {
        margin-bottom: 1.5rem;
      }

      .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      .modal-actions {
        display: flex !important;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 2rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
        background: var(--bg-primary);
        position: sticky;
        bottom: 0;
        z-index: 3002;
      }

      /* Responsive */
      @media (max-width: 1024px) {
        .dashboard-grid {
          grid-template-columns: 1fr 1fr;
        }
      }

      @media (max-width: 768px) {
        .header {
          padding: 1rem;
        }

        .container {
          padding: 1rem;
        }

        .dashboard-grid {
          grid-template-columns: 1fr;
          gap: 1rem;
        }

        .header-content {
          flex-direction: column;
          gap: 1rem;
        }

        .log-entry {
          grid-template-columns: 1fr;
          gap: 0.5rem;
        }
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }

      ::-webkit-scrollbar-track {
        background: var(--bg-tertiary);
      }

      ::-webkit-scrollbar-thumb {
        background: var(--text-secondary);
        border-radius: 3px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: var(--text-primary);
      }

      /* Duplicate modal CSS removed - using the definitions above */

      .search-engines {
        margin: 15px 0;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background: #f9f9f9;
      }

      .search-engines label {
        margin-right: 15px;
        cursor: pointer;
      }

      .search-engines input[type="checkbox"] {
        margin-right: 5px;
      }

      .search-engines-title {
        font-weight: bold;
        margin-bottom: 10px;
        color: #333;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <div class="logo">
          <i
            class="fas fa-search"
            style="color: var(--text-accent); font-size: 1.5rem"
          ></i>
          <h1>THREATDORKER</h1>
          <div class="live-indicator">
            <div class="live-dot"></div>
            LIVE
          </div>
        </div>

        <div class="header-controls">
          <div id="detailed-status" class="detailed-status">
            <div id="status-indicator" class="status-pill status-idle">
              Idle
            </div>
            <div id="status-details" class="status-details">Ready to start</div>
          </div>
          <button class="btn" id="start-stop-btn" style="display: none">
            <i class="fas fa-play"></i>
            Start
          </button>
          <button
            class="btn btn-primary"
            id="export-urls-btn"
            style="display: none"
          >
            <i class="fas fa-link"></i>
            Export URLs
          </button>
          <button class="btn" id="theme-toggle-btn">
            <i class="fas fa-moon" id="theme-icon"></i>
          </button>
          <button class="btn" id="fullscreen-toggle-btn">
            <i class="fas fa-expand"></i>
          </button>
          <button class="btn btn-primary" id="export-data-btn">
            <i class="fas fa-download"></i>
            Export All
          </button>
        </div>
      </div>
    </header>

    <!-- Main Dashboard -->
    <div class="container">
      <!-- Stats Grid -->
      <div class="dashboard-grid">
        <!-- Progress Card -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Progress</div>
            <svg class="progress-ring" width="60" height="60">
              <circle
                class="progress-ring-circle"
                cx="30"
                cy="30"
                r="26"
              ></circle>
              <circle
                class="progress-ring-progress"
                cx="30"
                cy="30"
                r="26"
                id="progress-circle"
              ></circle>
            </svg>
          </div>
          <div class="card-value" id="progress-percentage">0%</div>
          <div class="card-trend" id="progress-trend">
            <span id="processed-count">0</span> /
            <span id="total-count">0</span> dorks
          </div>
        </div>

        <!-- Success Rate -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Success Rate</div>
            <i
              class="fas fa-chart-line"
              style="color: var(--success-color)"
            ></i>
          </div>
          <div class="card-value" id="success-rate">0%</div>
          <div class="card-trend trend-up" id="success-trend">
            <i class="fas fa-arrow-up"></i>
            <span id="successful-count">0</span> successful
          </div>
        </div>

        <!-- Results Found -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Results Found</div>
            <i class="fas fa-database" style="color: var(--text-accent)"></i>
          </div>
          <div class="card-value" id="total-results">0</div>
          <div class="card-trend" id="results-trend">
            <span id="avg-results">0</span> avg per dork
          </div>
        </div>

        <!-- Performance Chart -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Performance</div>
            <i
              class="fas fa-tachometer-alt"
              style="color: var(--warning-color)"
            ></i>
          </div>
          <div class="chart-container">
            <canvas id="performanceChart"></canvas>
          </div>
        </div>

        <!-- Security Stats -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Security</div>
            <i class="fas fa-shield-alt" style="color: var(--error-color)"></i>
          </div>
          <div
            style="
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 1rem;
              margin-top: 1rem;
            "
          >
            <div>
              <div
                style="font-size: 1.5rem; font-weight: 700"
                id="captcha-encounters"
              >
                0
              </div>
              <div style="font-size: 0.75rem; color: var(--text-secondary)">
                CAPTCHAs
              </div>
            </div>
            <div>
              <div
                style="font-size: 1.5rem; font-weight: 700"
                id="captcha-solved"
              >
                0
              </div>
              <div style="font-size: 0.75rem; color: var(--text-secondary)">
                Solved
              </div>
            </div>
          </div>
          <div class="card-trend" id="captcha-rate" style="margin-top: 0.5rem">
            <span>0%</span> solve rate
          </div>
        </div>

        <!-- Runtime Info -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Session</div>
            <i class="fas fa-clock" style="color: var(--text-secondary)"></i>
          </div>
          <div style="margin-top: 1rem">
            <div style="margin-bottom: 0.5rem">
              <span style="color: var(--text-secondary); font-size: 0.875rem"
                >Runtime:</span
              >
              <span style="font-weight: 600" id="runtime">00:00:00</span>
            </div>
            <div style="margin-bottom: 0.5rem">
              <span style="color: var(--text-secondary); font-size: 0.875rem"
                >Started:</span
              >
              <span style="font-weight: 600" id="start-time">-</span>
            </div>
            <div>
              <span style="color: var(--text-secondary); font-size: 0.875rem"
                >Proxy:</span
              >
              <span style="font-weight: 600" id="current-proxy">None</span>
            </div>
          </div>
        </div>

        <!-- Configuration Info -->
        <div class="card" id="config-card" style="display: none">
          <div class="card-header">
            <div class="card-title">Configuration</div>
            <i class="fas fa-cog" style="color: var(--text-accent)"></i>
          </div>
          <div
            id="config-display"
            style="margin-top: 1rem; font-size: 0.875rem"
          >
            <div
              style="
                color: var(--text-secondary);
                text-align: center;
                padding: 1rem;
              "
            >
              Configuration will appear when session starts
            </div>
          </div>
        </div>
      </div>

      <!-- Live Status Section -->
      <div class="card wide-section">
        <div class="section-header">
          <div class="section-title">
            <i class="fas fa-heartbeat"></i>
            Live Status
          </div>
          <div class="live-indicator">
            <div class="live-dot"></div>
            LIVE
          </div>
        </div>
        <div class="status-container">
          <div class="main-status">
            <div id="main-status-pill" class="main-status-pill status-idle">
              <i class="fas fa-pause-circle"></i>
              <span>Idle</span>
            </div>
            <div id="main-status-text" class="main-status-text">
              Ready to start dorking session
            </div>
          </div>
          <div class="status-metrics">
            <div class="status-metric">
              <span class="metric-label">Progress</span>
              <span class="metric-value" id="live-progress">0 / 0</span>
            </div>
            <div class="status-metric">
              <span class="metric-label">Results</span>
              <span class="metric-value" id="live-results">0</span>
            </div>
            <div class="status-metric">
              <span class="metric-label">Runtime</span>
              <span class="metric-value" id="live-runtime">00:00:00</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Current Dork -->
      <div class="card wide-section">
        <div class="section-header">
          <div class="section-title">
            <i class="fas fa-search"></i>
            Current Processing
          </div>
          <div class="live-indicator">
            <div class="live-dot"></div>
            LIVE
          </div>
        </div>
        <div
          style="
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            word-break: break-all;
            font-size: 0.875rem;
          "
          id="current-dork"
        >
          No dork currently being processed
        </div>
      </div>

      <!-- Results Feed -->
      <div class="card wide-section">
        <div class="section-header">
          <div class="section-title">
            <i class="fas fa-list"></i>
            Results Feed
          </div>
          <div style="display: flex; gap: 1rem">
            <div class="live-indicator">
              <div class="live-dot"></div>
              LIVE
            </div>
            <button class="btn" id="clear-results-btn">
              <i class="fas fa-trash"></i>
              Clear
            </button>
          </div>
        </div>
        <div class="table-content" id="results-container">
          <div
            style="
              text-align: center;
              padding: 3rem;
              color: var(--text-secondary);
            "
          >
            <i
              class="fas fa-search"
              style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5"
            ></i>
            <div>Waiting for results...</div>
          </div>
        </div>
      </div>

      <!-- System Logs -->
      <div class="card wide-section">
        <div class="section-header">
          <div class="section-title">
            <i class="fas fa-terminal"></i>
            System Logs
          </div>
          <div style="display: flex; gap: 1rem">
            <div class="live-indicator">
              <div class="live-dot"></div>
              LIVE
            </div>
            <button class="btn" id="clear-logs-btn">
              <i class="fas fa-trash"></i>
              Clear
            </button>
          </div>
        </div>
        <div class="table-content" id="logs-container">
          <div
            style="
              text-align: center;
              padding: 3rem;
              color: var(--text-secondary);
            "
          >
            <i
              class="fas fa-terminal"
              style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5"
            ></i>
            <div>Waiting for system logs...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Notifications Container -->
    <div id="notifications-container"></div>

    <!-- Completion Popup -->
    <div id="completion-popup-overlay" class="completion-popup-overlay">
      <div id="completion-popup" class="completion-popup">
        <div class="completion-title">
          <i class="fas fa-trophy"></i>
          Dorking Complete!
        </div>
        <div id="completion-message" class="completion-message">
          Session completed successfully
        </div>
        <div id="completion-stats" class="completion-stats">
          <div class="completion-stat">
            <div id="completion-processed" class="completion-stat-value">0</div>
            <div class="completion-stat-label">Processed</div>
          </div>
          <div class="completion-stat">
            <div id="completion-success-rate" class="completion-stat-value">
              0%
            </div>
            <div class="completion-stat-label">Success Rate</div>
          </div>
          <div class="completion-stat">
            <div id="completion-total-results" class="completion-stat-value">
              0
            </div>
            <div class="completion-stat-label">Total Results</div>
          </div>
          <div class="completion-stat">
            <div id="completion-runtime" class="completion-stat-value">
              00:00:00
            </div>
            <div class="completion-stat-label">Runtime</div>
          </div>
        </div>
        <div class="completion-actions">
          <button class="btn btn-primary" id="completion-export-btn">
            <i class="fas fa-download"></i> Export URLs
          </button>
          <button class="btn" id="completion-close-btn">
            <i class="fas fa-times"></i> Close
          </button>
        </div>
      </div>
    </div>

    <!-- Configuration Modal -->
    <div class="modal" id="config-modal">
      <div class="modal-content" style="max-width: 600px">
        <div class="modal-header">
          <div class="modal-title">üîß Dorking Configuration</div>
        </div>
        <div style="padding: 1rem">
          <form id="config-form">
            <div style="margin-bottom: 1rem">
              <label
                style="display: block; margin-bottom: 0.5rem; font-weight: 500"
                >üìÅ Dork File Path</label
              >
              <input
                type="text"
                id="dork-file"
                name="dorkFile"
                value="dorks.txt"
                required
                style="
                  width: 100%;
                  padding: 0.5rem;
                  border: 1px solid var(--border-color);
                  border-radius: 6px;
                  background: var(--bg-primary);
                  color: var(--text-primary);
                "
              />
            </div>

            <div style="margin-bottom: 1rem">
              <label
                style="display: block; margin-bottom: 0.5rem; font-weight: 500"
                >üíæ Output File Path</label
              >
              <input
                type="text"
                id="output-file"
                name="outputFile"
                value="results.json"
                required
                style="
                  width: 100%;
                  padding: 0.5rem;
                  border: 1px solid var(--border-color);
                  border-radius: 6px;
                  background: var(--bg-primary);
                  color: var(--text-primary);
                "
              />
            </div>

            <div style="margin-bottom: 1rem">
              <label
                style="display: block; margin-bottom: 0.5rem; font-weight: 500"
                >üìä Results per Search</label
              >
              <input
                type="number"
                id="result-count"
                name="resultCount"
                value="30"
                min="1"
                max="100"
                required
                style="
                  width: 100%;
                  padding: 0.5rem;
                  border: 1px solid var(--border-color);
                  border-radius: 6px;
                  background: var(--bg-primary);
                  color: var(--text-primary);
                "
              />
            </div>

            <div style="margin-bottom: 1rem">
              <label
                style="display: block; margin-bottom: 0.5rem; font-weight: 500"
                >üìÑ Maximum Pages to Scrape per Dork</label
              >
              <input
                type="number"
                id="max-pages"
                name="maxPages"
                value="1"
                min="1"
                max="10"
                required
                style="
                  width: 100%;
                  padding: 0.5rem;
                  border: 1px solid var(--border-color);
                  border-radius: 6px;
                  background: var(--bg-primary);
                  color: var(--text-primary);
                "
              />
            </div>

            <div style="margin-bottom: 1rem">
              <label
                style="display: block; margin-bottom: 0.5rem; font-weight: 500"
                >‚è±Ô∏è Minimum Delay between Searches (seconds)</label
              >
              <input
                type="number"
                id="min-delay"
                name="minDelay"
                value="10"
                min="5"
                max="60"
                required
                style="
                  width: 100%;
                  padding: 0.5rem;
                  border: 1px solid var(--border-color);
                  border-radius: 6px;
                  background: var(--bg-primary);
                  color: var(--text-primary);
                "
              />
            </div>

            <div style="margin-bottom: 1rem">
              <label
                style="display: block; margin-bottom: 0.5rem; font-weight: 500"
                >‚è∞ Maximum Delay between Searches (seconds)</label
              >
              <input
                type="number"
                id="max-delay"
                name="maxDelay"
                value="45"
                min="5"
                max="120"
                required
                style="
                  width: 100%;
                  padding: 0.5rem;
                  border: 1px solid var(--border-color);
                  border-radius: 6px;
                  background: var(--bg-primary);
                  color: var(--text-primary);
                "
              />
            </div>

            <div style="margin-bottom: 1rem">
              <label
                style="display: block; margin-bottom: 0.5rem; font-weight: 500"
                >‚è∏Ô∏è Maximum Pause Length (seconds)</label
              >
              <input
                type="number"
                id="max-pause"
                name="maxPause"
                value="60"
                min="30"
                max="60"
                required
                style="
                  width: 100%;
                  padding: 0.5rem;
                  border: 1px solid var(--border-color);
                  border-radius: 6px;
                  background: var(--bg-primary);
                  color: var(--text-primary);
                "
              />
            </div>

            <div style="margin-bottom: 1rem">
              <label style="display: block; margin-bottom: 1rem">
                <input
                  type="checkbox"
                  id="extended-delay"
                  name="extendedDelay"
                  style="margin-right: 0.5rem"
                />
                üïê Enable extended automated delays (1-5 minutes between
                queries)
                <small
                  style="
                    display: block;
                    color: var(--text-secondary);
                    margin-left: 1.25rem;
                    margin-top: 0.25rem;
                  "
                >
                  Recommended for stealth dorking to avoid CAPTCHAs
                </small>
              </label>
            </div>

            <div style="margin-bottom: 1rem">
              <label
                style="display: block; margin-bottom: 0.5rem; font-weight: 500"
                >ü§ñ Custom User Agent (optional)</label
              >
              <input
                type="text"
                id="user-agent"
                name="userAgent"
                placeholder="Leave empty for default browser agent"
                style="
                  width: 100%;
                  padding: 0.5rem;
                  border: 1px solid var(--border-color);
                  border-radius: 6px;
                  background: var(--bg-primary);
                  color: var(--text-primary);
                "
              />
            </div>

            <div style="margin-bottom: 1rem">
              <label style="display: block; margin-bottom: 1rem">
                <input
                  type="checkbox"
                  id="headless-mode"
                  name="headless"
                  style="margin-right: 0.5rem"
                />
                üëÅÔ∏è Run browser in headless mode
              </label>

              <label style="display: block; margin-bottom: 1rem">
                <input
                  type="checkbox"
                  id="manual-captcha"
                  name="manualCaptchaMode"
                  style="margin-right: 0.5rem"
                />
                üîê Enable manual CAPTCHA solving
              </label>

              <label style="display: block; margin-bottom: 1rem">
                <input
                  type="checkbox"
                  id="human-like"
                  name="humanLike"
                  checked
                  style="margin-right: 0.5rem"
                />
                üé≠ Enable human-like behavior simulation
              </label>

              <label style="display: block; margin-bottom: 1rem">
                <input
                  type="checkbox"
                  id="auto-proxy"
                  name="autoProxy"
                  style="margin-right: 0.5rem"
                />
                üåç Enable automatic proxy switching via ASOCKS
              </label>

              <label style="display: block; margin-bottom: 1rem">
                <input
                  type="checkbox"
                  id="multi-engine"
                  name="multiEngine"
                  style="margin-right: 0.5rem"
                />
                üîç Enable multi-engine dorking
              </label>

              <div id="search-engines-container" style="margin-left: 1.5rem; margin-bottom: 1rem; display: none;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500">
                  Select Search Engines:
                </label>
                <label style="display: block; margin-bottom: 0.5rem">
                  <input
                    type="checkbox"
                    name="searchEngine"
                    value="google"
                    checked
                    style="margin-right: 0.5rem"
                  />
                  Google
                </label>
                <label style="display: block; margin-bottom: 0.5rem">
                  <input
                    type="checkbox"
                    name="searchEngine"
                    value="bing"
                    style="margin-right: 0.5rem"
                  />
                  Bing
                </label>
                <label style="display: block; margin-bottom: 0.5rem">
                  <input
                    type="checkbox"
                    name="searchEngine"
                    value="duckduckgo"
                    style="margin-right: 0.5rem"
                  />
                  DuckDuckGo
                </label>
              </div>

              <label style="display: block; margin-bottom: 1rem">
                <input
                  type="checkbox"
                  id="dork-filtering"
                  name="dorkFiltering"
                  checked
                  style="margin-right: 0.5rem"
                />
                üéØ Enable dork-based URL filtering
                <small
                  style="
                    display: block;
                    color: var(--text-secondary);
                    margin-left: 1.25rem;
                    margin-top: 0.25rem;
                  "
                >
                  Only keep URLs that match the dork pattern (e.g.,
                  inurl:index.php?id= filters URLs without "index.php?id=")
                </small>
              </label>
            </div>
          </form>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn" id="config-cancel-btn">
            Cancel
          </button>
          <button type="button" class="btn btn-primary" id="config-start-btn">
            <i class="fas fa-play"></i>
            Start Dorking
          </button>
        </div>
      </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="export-modal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">Export Data</div>
        </div>
        <div>
          <label style="display: block; margin-bottom: 1rem">
            <input
              type="checkbox"
              id="export-results"
              checked
              style="margin-right: 0.5rem"
            />
            Export Results
          </label>
          <label style="display: block; margin-bottom: 1rem">
            <input
              type="checkbox"
              id="export-logs"
              checked
              style="margin-right: 0.5rem"
            />
            Export Logs
          </label>
          <label style="display: block; margin-bottom: 1rem">
            <input
              type="checkbox"
              id="export-stats"
              checked
              style="margin-right: 0.5rem"
            />
            Export Statistics
          </label>
        </div>
        <div class="modal-actions">
          <button class="btn" id="modal-cancel-btn">Cancel</button>
          <button class="btn btn-primary" id="modal-export-btn">
            <i class="fas fa-download"></i>
            Export
          </button>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      const socket = io();
      let startTime = null;
      let runtimeInterval = null;
      let performanceChart = null;
      let sessionData = {
        results: [],
        logs: [],
        stats: {},
        performanceData: [],
      };

      // Initialize dashboard
      document.addEventListener("DOMContentLoaded", () => {
        initializeCharts();
        setupEventListeners();
        setupInfiniteScroll();
        checkServerMode();

        // Ensure completion popup is hidden on page load
        closeCompletionPopup();

        // Load theme preference
        const savedTheme = localStorage.getItem("dashboard-theme") || "light";
        if (savedTheme === "dark") {
          document.documentElement.setAttribute("data-theme", "dark");
          document.getElementById("theme-icon").className = "fas fa-sun";
        }
      });

      // Enhanced Socket event handlers with reconnection logic
      socket.on("connect", () => {
        reconnectAttempts = 0;
        showNotification("Connected to server", "success");
        console.log("‚úÖ Dashboard connected");

        // Request initial data on connect/reconnect
        socket.emit("requestData");
      });

      socket.on("disconnect", (reason) => {
        console.log("‚ùå Dashboard disconnected:", reason);

        // Only show error notification if page is visible
        if (isPageVisible) {
          showNotification(
            "Connection lost - attempting to reconnect...",
            "warning"
          );
        }

        // Stop heartbeat on disconnect
        stopHeartbeat();
      });

      socket.on("connect_error", (error) => {
        console.log("‚ùå Connection error:", error);

        if (isPageVisible && reconnectAttempts < maxReconnectAttempts) {
          reconnectAttempts++;
          showNotification(
            `Connection failed (${reconnectAttempts}/${maxReconnectAttempts}) - retrying...`,
            "warning"
          );
        }
      });

      socket.on("reconnect", (attemptNumber) => {
        reconnectAttempts = 0;
        console.log(`‚úÖ Reconnected after ${attemptNumber} attempts`);

        if (isPageVisible) {
          showNotification("Reconnected successfully!", "success");
        }

        // Restart heartbeat on reconnect
        startHeartbeat();

        // Request fresh data after reconnection
        socket.emit("requestData");
      });

      socket.on("reconnect_failed", () => {
        console.log("‚ùå Failed to reconnect after maximum attempts");

        if (isPageVisible) {
          showNotification(
            "Unable to reconnect - please refresh the page",
            "error"
          );
        }
      });

      // Handle initial data loading
      socket.on("initialResults", (results) => {
        console.log("üìä Loading initial results:", results.length);
        sessionData.results = results;

        // Populate results container with existing results
        const resultsContainer = document.getElementById("results-container");
        resultsContainer.innerHTML = "";

        if (results.length === 0) {
          resultsContainer.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
              <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
              <div>No results yet - start a dorking session to see results here</div>
            </div>
          `;
        } else {
          // Add all existing results
          results.forEach((result) => {
            addResult(result);
          });

          // Show export button if there are results
          const exportUrlsBtn = document.getElementById("export-urls-btn");
          if (exportUrlsBtn) {
            exportUrlsBtn.style.display = "inline-flex";
          }
        }
      });

      socket.on("initialLogs", (logs) => {
        console.log("üìã Loading initial logs:", logs.length);
        sessionData.logs = logs;

        // Populate logs container with existing logs
        const logsContainer = document.getElementById("logs-container");
        logsContainer.innerHTML = "";

        if (logs.length === 0) {
          logsContainer.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
              <i class="fas fa-terminal" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
              <div>No logs yet - start a dorking session to see system logs here</div>
            </div>
          `;
        } else {
          // Add all existing logs
          logs.forEach((log) => {
            addLog(log);
          });
        }
      });

      socket.on("performanceData", (performanceData) => {
        console.log("üìà Loading performance data:", performanceData.length);
        sessionData.performanceData = performanceData.map((data) => ({
          time: new Date(data.timestamp),
          processed: data.processed,
          successful: data.successful,
          results: data.totalResults,
        }));
        updatePerformanceChart();
      });

      socket.on("stats", (stats) => {
        updateStats(stats);
        sessionData.stats = stats;

        // Add performance data point
        sessionData.performanceData.push({
          time: new Date(),
          processed: stats.processedDorks,
          successful: stats.successfulDorks,
          results: stats.totalResults,
        });

        updatePerformanceChart();
      });

      socket.on("sessionStart", (stats) => {
        startTime = new Date(stats.startTime);
        // Clear data for new session - this ensures fresh start
        sessionData = {
          results: [],
          logs: [],
          stats: stats,
          performanceData: [],
        };

        console.log("üéØ Session started! Live stats now active:", stats);

        // Update all stats immediately with real data
        document.getElementById("progress-percentage").textContent = "0%";
        document.getElementById("processed-count").textContent = "0";
        document.getElementById("total-count").textContent =
          stats.totalDorks || 0;
        document.getElementById("success-rate").textContent = "0%";
        document.getElementById("successful-count").textContent = "0";
        document.getElementById("total-results").textContent = "0";
        document.getElementById("avg-results").textContent = "0";
        document.getElementById("captcha-encounters").textContent = "0";
        document.getElementById("captcha-solved").textContent = "0";
        document.getElementById("captcha-rate").innerHTML =
          "<span>0%</span> solve rate";

        // Update status and progress
        updateStatus(stats.status || "running");
        updateProgressRing(0);

        // Set start time display
        document.getElementById("start-time").textContent =
          startTime.toLocaleTimeString();
        document.getElementById("runtime").textContent = "00:00:00";

        // Update current session info
        document.getElementById("current-dork").textContent =
          stats.currentDork || "Waiting for first dork...";
        document.getElementById("current-proxy").textContent = stats.proxy
          ? `${stats.proxy.host}:${stats.proxy.port}`
          : "None";

        // Clear and reset containers for live data
        const resultsContainer = document.getElementById("results-container");
        resultsContainer.innerHTML = `
          <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
            <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <div>üîç Session active - waiting for results...</div>
          </div>
        `;

        const logsContainer = document.getElementById("logs-container");
        logsContainer.innerHTML = `
          <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
            <i class="fas fa-terminal" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <div>üìã Session active - waiting for logs...</div>
          </div>
        `;

        // Reset performance chart
        if (performanceChart) {
          performanceChart.data.labels = [];
          performanceChart.data.datasets[0].data = [];
          performanceChart.update();
        }

        // Start runtime timer
        if (runtimeInterval) {
          clearInterval(runtimeInterval);
        }
        runtimeInterval = setInterval(updateRuntime, 1000);

        showNotification(
          "üöÄ Session started - live stats now active!",
          "success"
        );
      });

      socket.on("newResult", (result) => {
        addResult(result);
        sessionData.results.unshift(result);

        // Show notification with more detail
        const dorkPreview =
          result.dork.length > 30
            ? result.dork.substring(0, 30) + "..."
            : result.dork;
        showNotification(
          `üéØ Found ${result.count} results for: ${dorkPreview}`,
          "success"
        );

        console.log("üéØ New result received:", result);
      });

      socket.on("processingStatus", (data) => {
        // Update status details with the processing status (countdown, etc)
        const detailsEl = document.getElementById("status-details");
        const mainStatusText = document.getElementById("main-status-text");
        
        if (data && data.status) {
          detailsEl.textContent = data.status;
          if (mainStatusText) {
            mainStatusText.textContent = data.status;
          }
        }
      });

      socket.on("newLog", (log) => {
        addLog(log);
        sessionData.logs.unshift(log);

        // Enhanced status detection from log messages
        const message = log.message.toLowerCase();

        if (message.includes("warming up") || message.includes("warm-up")) {
          updateStatus("warming-up", "Browser warming up session...");
        } else if (
          message.includes("captcha") &&
          message.includes("detected")
        ) {
          updateStatus("captcha", "CAPTCHA challenge detected - solving...");
        } else if (message.includes("captcha") && message.includes("solved")) {
          updateStatus("searching", "CAPTCHA solved - resuming search...");
        } else if (
          message.includes("testing asocks") ||
          message.includes("api connection")
        ) {
          updateStatus("initializing", "Testing proxy connections...");
        } else if (
          message.includes("proxy switch") ||
          message.includes("switching proxy")
        ) {
          updateStatus("initializing", "Switching to new proxy...");
        } else if (
          message.includes("performing search") ||
          message.includes("searching")
        ) {
          updateStatus("searching", "Performing search query...");
        } else if (message.includes("extracting results")) {
          updateStatus("searching", "Extracting search results...");
        } else if (message.includes("delaying") && message.includes("search")) {
          updateStatus("searching", "Waiting between searches...");
        }

        // Show important logs as notifications
        if (log.level === "error") {
          showNotification(`‚ö†Ô∏è ${log.message}`, "warning");
        } else if (
          message.includes("captcha") ||
          message.includes("proxy") ||
          message.includes("warm")
        ) {
          showNotification(`üìã ${log.message}`, "info");
        }

        console.log("üìã New log:", log);
      });

      socket.on("notification", (notification) => {
        if (notification.type === "completion") {
          showCompletionPopup(notification);
        } else {
          showNotification(notification.message, notification.type);
        }
      });

      socket.on("sessionEnd", (data) => {
        console.log("üèÅ Session ended:", data);

        // Clear runtime interval
        if (runtimeInterval) {
          clearInterval(runtimeInterval);
          runtimeInterval = null;
        }

        // Update UI back to completed/idle state
        updateStatus(data.success ? "completed" : "idle");

        // Show completion notification
        if (data.success) {
          showNotification(
            "‚úÖ Dorking session completed successfully!",
            "success"
          );
        } else {
          showNotification("‚ö†Ô∏è Dorking session ended", "warning");
        }

        // Immediately switch back to start mode
        const startStopBtn = document.getElementById("start-stop-btn");
        if (startStopBtn) {
          startStopBtn.innerHTML = '<i class="fas fa-play"></i> Start';
          startStopBtn.className = "btn btn-primary";
          startStopBtn.style.borderColor = "";
          startStopBtn.style.color = "";
          startStopBtn.style.display = "inline-flex";

          console.log("üîÑ Button changed back to Start mode");
        }

        // Keep export URLs button visible if there are results
        const exportUrlsBtn = document.getElementById("export-urls-btn");
        if (
          exportUrlsBtn &&
          sessionData.results &&
          sessionData.results.length > 0
        ) {
          exportUrlsBtn.style.display = "inline-flex";
          console.log("üìé Export URLs button kept visible");
        }

        // Update runtime display to final time
        if (startTime) {
          const finalRuntime = Date.now() - startTime.getTime();
          const hours = Math.floor(finalRuntime / 3600000);
          const minutes = Math.floor((finalRuntime % 3600000) / 60000);
          const seconds = Math.floor((finalRuntime % 60000) / 1000);
          const runtimeDisplay = `${hours.toString().padStart(2, "0")}:${minutes
            .toString()
            .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;

          const runtimeEl = document.getElementById("runtime");
          if (runtimeEl) {
            runtimeEl.textContent = runtimeDisplay;
          }
        }

        console.log("üèÅ Session end handling completed");
      });

      socket.on("error", (error) => {
        console.error("‚ùå Socket error:", error);
        showNotification(`‚ùå Connection error: ${error.message}`, "error");
      });

      // Update functions - Enhanced for real-time live stats
      function updateStats(stats) {
        console.log("üìä Live stats update:", stats);

        // Progress with live animation
        const progress =
          stats.totalDorks > 0
            ? (stats.processedDorks / stats.totalDorks) * 100
            : 0;
        document.getElementById("progress-percentage").textContent =
          Math.round(progress) + "%";
        document.getElementById("processed-count").textContent =
          stats.processedDorks || 0;
        document.getElementById("total-count").textContent =
          stats.totalDorks || 0;
        updateProgressRing(progress);

        // Success rate with trend indication
        const successRate =
          stats.processedDorks > 0
            ? Math.round((stats.successfulDorks / stats.processedDorks) * 100)
            : 0;
        document.getElementById("success-rate").textContent = successRate + "%";
        document.getElementById("successful-count").textContent =
          stats.successfulDorks || 0;

        // Results metrics
        document.getElementById("total-results").textContent =
          stats.totalResults || 0;
        const avgResults =
          stats.successfulDorks > 0
            ? Math.round(stats.totalResults / stats.successfulDorks)
            : 0;
        document.getElementById("avg-results").textContent = avgResults;

        // Update live status metrics
        const liveProgress = document.getElementById("live-progress");
        const liveResults = document.getElementById("live-results");
        const liveRuntime = document.getElementById("live-runtime");

        if (liveProgress) {
          liveProgress.textContent = `${stats.processedDorks || 0} / ${
            stats.totalDorks || 0
          }`;
        }
        if (liveResults) {
          liveResults.textContent = stats.totalResults || 0;
        }
        if (liveRuntime && startTime) {
          const now = new Date();
          const diff = now - startTime;
          const hours = Math.floor(diff / (1000 * 60 * 60));
          const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((diff % (1000 * 60)) / 1000);
          const runtime = `${hours.toString().padStart(2, "0")}:${minutes
            .toString()
            .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
          liveRuntime.textContent = runtime;
        }

        // Security metrics
        document.getElementById("captcha-encounters").textContent =
          stats.captchaEncounters || 0;
        document.getElementById("captcha-solved").textContent =
          stats.captchaSolved || 0;
        const captchaRate =
          stats.captchaEncounters > 0
            ? Math.round((stats.captchaSolved / stats.captchaEncounters) * 100)
            : 0;
        document.getElementById(
          "captcha-rate"
        ).innerHTML = `<span>${captchaRate}%</span> solve rate`;

        // Live status updates
        updateStatus(stats.status || "running");

        // Current activity - show what's happening right now
        const currentDorkText = stats.currentDork || "Waiting for next dork...";
        document.getElementById("current-dork").textContent = currentDorkText;

        // Proxy information
        const proxyText = stats.proxy
          ? `${stats.proxy.host}:${stats.proxy.port}`
          : "Direct connection";
        document.getElementById("current-proxy").textContent = proxyText;

        // Update configuration display
        updateConfigurationDisplay(stats.config);

        // Initialize start time if not set
        if (stats.startTime && !startTime) {
          startTime = new Date(stats.startTime);
          document.getElementById("start-time").textContent =
            startTime.toLocaleTimeString();

          if (!runtimeInterval) {
            runtimeInterval = setInterval(updateRuntime, 1000);
          }
        }

        // Add visual feedback for active updates
        const statusEl = document.getElementById("status-indicator");
        if (statusEl && stats.status === "running") {
          statusEl.style.animation = "pulse 2s infinite";
          setTimeout(() => {
            if (statusEl) statusEl.style.animation = "";
          }, 1000);
        }
      }

      function updateStatus(status, details = null) {
        const statusEl = document.getElementById("status-indicator");
        const detailsEl = document.getElementById("status-details");
        const mainStatusPill = document.getElementById("main-status-pill");
        const mainStatusText = document.getElementById("main-status-text");

        // Update header status pill
        statusEl.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        statusEl.className = `status-pill status-${status.replace(
          /[^a-z-]/gi,
          ""
        )}`;

        // Update main status pill
        const statusIcons = {
          idle: "fas fa-pause-circle",
          initializing: "fas fa-cog fa-spin",
          "warming-up": "fas fa-fire",
          searching: "fas fa-search",
          "delaying-search": "fas fa-clock",
          captcha: "fas fa-lock",
          "captcha-transcribing": "fas fa-microphone",
          "captcha-proxy": "fas fa-globe",
          running: "fas fa-play-circle",
          completed: "fas fa-check-circle",
          error: "fas fa-exclamation-circle",
          stopped: "fas fa-stop-circle",
        };

        const icon = statusIcons[status] || "fas fa-question-circle";
        const cleanStatus = status.replace(/[^a-z-]/gi, "");

        if (mainStatusPill) {
          mainStatusPill.className = `main-status-pill status-${cleanStatus}`;
          mainStatusPill.innerHTML = `
            <i class="${icon}"></i>
            <span>${status.charAt(0).toUpperCase() + status.slice(1)}</span>
          `;
        }

        // Update status details/text
        const statusText = details || getDefaultStatusText(status);
        detailsEl.textContent = statusText;
        if (mainStatusText) {
          mainStatusText.textContent = statusText;
        }

        if (details) {
          detailsEl.style.display = "block";
        }

        console.log(`üîÑ Status updated: ${status} - ${statusText}`);
      }

      // Update configuration display
      function updateConfigurationDisplay(config) {
        const configCard = document.getElementById("config-card");
        const configDisplay = document.getElementById("config-display");

        if (!config) {
          configCard.style.display = "none";
          return;
        }

        configCard.style.display = "block";

        const configItems = [
          { label: "üìÅ Dork File", value: config.dorkFile || "N/A" },
          { label: "üíæ Output File", value: config.outputFile || "N/A" },
          {
            label: "üìä Results per Search",
            value: config.resultCount || "N/A",
          },
          { label: "üìÑ Max Pages", value: config.maxPages || "N/A" },
          { label: "‚è±Ô∏è Min Delay", value: `${config.minDelay || 0}s` },
          { label: "‚è∞ Max Delay", value: `${config.maxDelay || 0}s` },
          {
            label: "üïê Extended Delay",
            value: config.extendedDelay ? "Yes" : "No",
          },
          { label: "üëÅÔ∏è Headless", value: config.headless ? "Yes" : "No" },
          {
            label: "üîê Manual CAPTCHA",
            value: config.manualCaptchaMode ? "Yes" : "No",
          },
          { label: "üé≠ Human-like", value: config.humanLike ? "Yes" : "No" },
          { label: "üåç Auto Proxy", value: config.autoProxy ? "Yes" : "No" },
        ];

        configDisplay.innerHTML = configItems
          .map(
            (item) => `
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; padding: 0.25rem 0;">
              <span style="color: var(--text-secondary);">${item.label}:</span>
              <span style="font-weight: 600; text-align: right; max-width: 60%; word-break: break-all;">${item.value}</span>
            </div>
          `
          )
          .join("");
      }

      function getDefaultStatusText(status) {
        switch (status) {
          case "idle":
            return "Ready to start dorking session";
          case "initializing":
            return "Setting up browser and connections...";
          case "warming-up":
            return "Warming up browser session...";
          case "searching":
            return "Actively searching for results...";
          case "delaying-search":
            return "Waiting between searches for safety...";
          case "captcha":
            return "CAPTCHA detected - attempting to solve...";
          case "captcha-transcribing":
            return "Transcribing CAPTCHA audio using AI...";
          case "captcha-proxy":
            return "Bypassing CAPTCHA with proxy switch...";
          case "running":
            return "Session active and processing dorks";
          case "completed":
            return "Session completed successfully";
          case "error":
            return "An error occurred during processing";
          case "stopped":
            return "Session stopped by user";
          default:
            return status;
        }
      }

      function updateProgressRing(progress) {
        const circle = document.getElementById("progress-circle");
        const radius = 26;
        const circumference = 2 * Math.PI * radius;
        const offset = circumference - (progress / 100) * circumference;
        circle.style.strokeDasharray = circumference;
        circle.style.strokeDashoffset = offset;
      }

      function updateRuntime() {
        if (startTime) {
          const now = new Date();
          const diff = now - startTime;
          const hours = Math.floor(diff / (1000 * 60 * 60));
          const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((diff % (1000 * 60)) / 1000);

          const runtime = `${hours.toString().padStart(2, "0")}:${minutes
            .toString()
            .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
          document.getElementById("runtime").textContent = runtime;
        }
      }

      function initializeCharts() {
        try {
          if (typeof Chart === "undefined") {
            console.warn("Chart.js not loaded, skipping chart initialization");
            return;
          }

          const ctx = document
            .getElementById("performanceChart")
            .getContext("2d");
          performanceChart = new Chart(ctx, {
            type: "line",
            data: {
              labels: [],
              datasets: [
                {
                  label: "Results Found",
                  data: [],
                  borderColor: "rgb(59, 130, 246)",
                  backgroundColor: "rgba(59, 130, 246, 0.1)",
                  tension: 0.4,
                  fill: true,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  grid: { color: "rgba(156, 163, 175, 0.2)" },
                  ticks: { color: "rgb(156, 163, 175)" },
                },
                x: {
                  grid: { color: "rgba(156, 163, 175, 0.2)" },
                  ticks: { color: "rgb(156, 163, 175)" },
                },
              },
              plugins: {
                legend: { display: false },
              },
            },
          });
        } catch (error) {
          console.error("Error initializing charts:", error);
        }
      }

      function updatePerformanceChart() {
        if (!performanceChart || sessionData.performanceData.length === 0)
          return;

        const data = sessionData.performanceData.slice(-20); // Last 20 data points

        performanceChart.data.labels = data.map((d) =>
          d.time.toLocaleTimeString()
        );
        performanceChart.data.datasets[0].data = data.map((d) => d.results);
        performanceChart.update("none");
      }

      // Infinite scroll functionality
      function addInfiniteScrollLoader(container, type) {
        const loader = document.createElement("div");
        loader.className = "infinite-scroll-loader";
        loader.innerHTML = `
          <div style="text-align: center; padding: 1rem; color: var(--text-secondary);">
            <i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>
            Scroll down to load older ${type}...
          </div>
        `;
        container.appendChild(loader);
      }

      function setupInfiniteScroll() {
        const resultsContainer = document.getElementById("results-container");
        const logsContainer = document.getElementById("logs-container");

        // Results infinite scroll
        let resultsScrollThrottle = false;
        resultsContainer.addEventListener("scroll", () => {
          if (resultsScrollThrottle) return;
          resultsScrollThrottle = true;

          setTimeout(() => {
            const { scrollTop, scrollHeight, clientHeight } = resultsContainer;
            if (scrollTop + clientHeight >= scrollHeight - 10) {
              // User scrolled to bottom - could load more historical results here
              const loader = resultsContainer.querySelector(
                ".infinite-scroll-loader"
              );
              if (loader) {
                loader.innerHTML = `
                  <div style="text-align: center; padding: 1rem; color: var(--text-secondary);">
                    <i class="fas fa-check" style="margin-right: 0.5rem;"></i>
                    All results loaded
                  </div>
                `;
              }
            }
            resultsScrollThrottle = false;
          }, 100);
        });

        // Logs infinite scroll
        let logsScrollThrottle = false;
        logsContainer.addEventListener("scroll", () => {
          if (logsScrollThrottle) return;
          logsScrollThrottle = true;

          setTimeout(() => {
            const { scrollTop, scrollHeight, clientHeight } = logsContainer;
            if (scrollTop + clientHeight >= scrollHeight - 10) {
              // User scrolled to bottom - could load more historical logs here
              const loader = logsContainer.querySelector(
                ".infinite-scroll-loader"
              );
              if (loader) {
                loader.innerHTML = `
                  <div style="text-align: center; padding: 1rem; color: var(--text-secondary);">
                    <i class="fas fa-check" style="margin-right: 0.5rem;"></i>
                    All logs loaded
                  </div>
                `;
              }
            }
            logsScrollThrottle = false;
          }, 100);
        });
      }

      function addResult(result) {
        const container = document.getElementById("results-container");

        // Remove placeholder
        if (container.querySelector('div[style*="text-align: center"]')) {
          container.innerHTML = "";
        }

        const resultEl = document.createElement("div");
        resultEl.className = "result-card";

        const urlElements = result.results
          .map(
            (url) =>
              `<div class="result-url-container">
                 <div class="result-url-title">${escapeHtml(
                   url.title || "No title"
                 )}</div>
                 <a href="${
                   url.url
                 }" target="_blank" class="result-url">${escapeHtml(
                url.url
              )}</a>
               </div>`
          )
          .join("");

        resultEl.innerHTML = `
          <div class="result-header">
            <div class="result-dork">${escapeHtml(result.dork)}</div>
            <div class="result-count">${result.count} results</div>
          </div>
          <div class="result-urls" style="max-height: 400px; overflow-y: auto; padding-right: 8px;">${urlElements}</div>
        `;

        container.insertBefore(resultEl, container.firstChild);

        // Infinite scroll - keep all results, auto-scroll to show latest
        if (container.children.length === 1) {
          // First result, scroll to top
          container.scrollTop = 0;
        }

        // Add loading indicator if more than 50 results (for performance)
        if (
          container.children.length > 50 &&
          !container.querySelector(".infinite-scroll-loader")
        ) {
          addInfiniteScrollLoader(container, "results");
        }
      }

      function addLog(log) {
        const container = document.getElementById("logs-container");

        // Remove placeholder
        if (container.querySelector('div[style*="text-align: center"]')) {
          container.innerHTML = "";
        }

        // Filter for important logs
        const isImportantLog = isLogImportant(log);

        const logEl = document.createElement("div");
        logEl.className = isImportantLog
          ? "log-entry important-log"
          : "log-entry";

        const time = new Date(log.timestamp).toLocaleTimeString();

        // Add icons for important log types
        let logIcon = "";
        const message = log.message.toLowerCase();
        if (message.includes("captcha")) {
          logIcon = "üîí ";
        } else if (message.includes("proxy")) {
          logIcon = "üåç ";
        } else if (message.includes("warm")) {
          logIcon = "üî• ";
        } else if (message.includes("search") || message.includes("dork")) {
          logIcon = "üîç ";
        } else if (message.includes("result")) {
          logIcon = "üìä ";
        } else if (log.level === "error") {
          logIcon = "‚ùå ";
        } else if (log.level === "success") {
          logIcon = "‚úÖ ";
        }

        logEl.innerHTML = `
          <span class="log-time">${time}</span>
          <span class="log-level ${log.level}">${log.level}</span>
          <span class="log-message">${logIcon}${escapeHtml(log.message)}</span>
        `;

        container.insertBefore(logEl, container.firstChild);

        // Infinite scroll - keep all logs, auto-scroll to show latest
        if (container.children.length === 1) {
          // First log, scroll to top
          container.scrollTop = 0;
        }

        // Add loading indicator if more than 200 logs (for performance)
        if (
          container.children.length > 200 &&
          !container.querySelector(".infinite-scroll-loader")
        ) {
          addInfiniteScrollLoader(container, "logs");
        }
      }

      function isLogImportant(log) {
        const message = log.message.toLowerCase();
        const importantKeywords = [
          "captcha",
          "proxy",
          "warm",
          "error",
          "failed",
          "success",
          "completed",
          "started",
          "api",
          "connection",
          "browser",
          "result",
          "found",
          "extracted",
        ];

        return (
          log.level === "error" ||
          log.level === "success" ||
          importantKeywords.some((keyword) => message.includes(keyword))
        );
      }

      function showNotification(message, type = "info") {
        const container = document.getElementById("notifications-container");

        const notification = document.createElement("div");
        notification.className = `notification notification-${type}`;
        const notificationContent = document.createElement("div");
        notificationContent.style.cssText =
          "display: flex; justify-content: space-between; align-items: center;";

        const messageSpan = document.createElement("span");
        messageSpan.textContent = message;

        const closeBtn = document.createElement("button");
        closeBtn.style.cssText =
          "background: none; border: none; cursor: pointer; color: var(--text-secondary);";
        closeBtn.innerHTML = '<i class="fas fa-times"></i>';
        closeBtn.addEventListener("click", () => notification.remove());

        notificationContent.appendChild(messageSpan);
        notificationContent.appendChild(closeBtn);
        notification.appendChild(notificationContent);

        container.appendChild(notification);

        // Show notification
        setTimeout(() => notification.classList.add("show"), 100);

        // Auto remove after 5 seconds
        setTimeout(() => {
          notification.classList.remove("show");
          setTimeout(() => notification.remove(), 300);
        }, 5000);
      }

      // Completion notification and popup functions
      function showCompletionPopup(notification) {
        const overlay = document.getElementById("completion-popup-overlay");
        const popup = document.getElementById("completion-popup");

        // Update popup content with session data
        document.getElementById("completion-message").textContent =
          notification.message;

        // Get current session stats
        const stats = sessionData.stats || {};
        document.getElementById("completion-processed").textContent =
          stats.processedDorks || 0;
        document.getElementById("completion-success-rate").textContent =
          stats.processedDorks > 0
            ? Math.round((stats.successfulDorks / stats.processedDorks) * 100) +
              "%"
            : "0%";
        document.getElementById("completion-total-results").textContent =
          stats.totalResults || 0;

        // Calculate runtime
        if (startTime) {
          const runtime = Date.now() - startTime.getTime();
          const hours = Math.floor(runtime / 3600000);
          const minutes = Math.floor((runtime % 3600000) / 60000);
          const seconds = Math.floor((runtime % 60000) / 1000);
          document.getElementById("completion-runtime").textContent = `${hours
            .toString()
            .padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${seconds
            .toString()
            .padStart(2, "0")}`;
        } else {
          document.getElementById("completion-runtime").textContent =
            "00:00:00";
        }

        // Show popup with animation
        overlay.classList.add("show");
        popup.classList.add("show");

        // Also show regular notification
        showNotification(notification.message, "completion");

        // Auto-update UI for completion state
        updateStatus("completed", "All dorks processed successfully!");

        // Update start/stop button back to start mode
        const startStopBtn = document.getElementById("start-stop-btn");
        if (startStopBtn) {
          startStopBtn.innerHTML = '<i class="fas fa-play"></i> Start';
          startStopBtn.className = "btn btn-primary";
          startStopBtn.style.borderColor = "";
          startStopBtn.style.color = "";
          startStopBtn.style.display = "inline-flex";

          console.log("üéâ Completion popup: Button changed back to Start mode");
        }

        console.log("üéâ Completion popup shown with stats:", {
          processed: stats.processedDorks,
          successRate:
            stats.processedDorks > 0
              ? Math.round((stats.successfulDorks / stats.processedDorks) * 100)
              : 0,
          totalResults: stats.totalResults,
        });
      }

      function closeCompletionPopup() {
        const overlay = document.getElementById("completion-popup-overlay");
        const popup = document.getElementById("completion-popup");

        overlay.classList.remove("show");
        popup.classList.remove("show");

        console.log("üéâ Completion popup closed");
      }

      function exportURLsFromCompletion() {
        // Use the same export logic as the main export function
        exportURLs();

        // Close the popup after export
        closeCompletionPopup();
      }

      function setupEventListeners() {
        // Request initial data when page loads
        socket.emit("requestData");
        console.log("üì° Requesting initial data from server...");

        // Header control buttons
        document
          .getElementById("start-stop-btn")
          .addEventListener("click", handleStartStopClick);
        document
          .getElementById("export-urls-btn")
          .addEventListener("click", exportURLs);
        document
          .getElementById("theme-toggle-btn")
          .addEventListener("click", toggleTheme);
        document
          .getElementById("fullscreen-toggle-btn")
          .addEventListener("click", toggleFullscreen);
        document
          .getElementById("export-data-btn")
          .addEventListener("click", exportData);

        // Action buttons
        document
          .getElementById("clear-results-btn")
          .addEventListener("click", clearResults);
        document
          .getElementById("clear-logs-btn")
          .addEventListener("click", clearLogs);

        // Modal buttons
        document
          .getElementById("modal-cancel-btn")
          .addEventListener("click", closeModal);
        document
          .getElementById("modal-export-btn")
          .addEventListener("click", performExport);

        // Configuration modal buttons
        document
          .getElementById("config-cancel-btn")
          .addEventListener("click", closeConfigModal);
        document
          .getElementById("config-start-btn")
          .addEventListener("click", startDorkingWithConfig);

        // Multi-engine checkbox toggle
        document
          .getElementById("multi-engine")
          .addEventListener("change", (e) => {
            const container = document.getElementById("search-engines-container");
            container.style.display = e.target.checked ? "block" : "none";
          });

        // Completion popup buttons
        document
          .getElementById("completion-close-btn")
          .addEventListener("click", closeCompletionPopup);
        document
          .getElementById("completion-export-btn")
          .addEventListener("click", exportURLsFromCompletion);

        // Close completion popup when clicking overlay
        document
          .getElementById("completion-popup-overlay")
          .addEventListener("click", (e) => {
            if (e.target.id === "completion-popup-overlay") {
              closeCompletionPopup();
            }
          });

        // Close modal when clicking outside
        document
          .getElementById("export-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "export-modal") {
              closeModal();
            }
          });

        document
          .getElementById("config-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "config-modal") {
              closeConfigModal();
            }
          });

        // Enhanced connection management with page visibility handling
        let heartbeatInterval = null;
        let isPageVisible = !document.hidden;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        // Page visibility change handler
        document.addEventListener("visibilitychange", () => {
          isPageVisible = !document.hidden;

          if (isPageVisible) {
            console.log("üåü Tab became visible - resuming normal operation");
            startHeartbeat();

            // Force reconnection if disconnected while tab was hidden
            if (!socket.connected) {
              console.log("üîÑ Reconnecting after tab became visible...");
              socket.connect();
            }

            // Request fresh data when tab becomes visible
            setTimeout(() => {
              if (socket.connected) {
                socket.emit("requestData");
              }
            }, 1000);
          } else {
            console.log("üåô Tab became hidden - pausing heartbeat");
            stopHeartbeat();
          }
        });

        // Start heartbeat function
        function startHeartbeat() {
          stopHeartbeat(); // Clear any existing heartbeat

          heartbeatInterval = setInterval(() => {
            if (socket.connected && isPageVisible) {
              socket.emit("ping", Date.now());
            }
          }, 30000);
        }

        // Stop heartbeat function
        function stopHeartbeat() {
          if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
            heartbeatInterval = null;
          }
        }

        // Start initial heartbeat
        startHeartbeat();
      }

      // UI Functions
      function toggleTheme() {
        const current = document.documentElement.getAttribute("data-theme");
        const newTheme = current === "dark" ? "light" : "dark";

        document.documentElement.setAttribute("data-theme", newTheme);
        localStorage.setItem("dashboard-theme", newTheme);

        const icon = document.getElementById("theme-icon");
        icon.className = newTheme === "dark" ? "fas fa-sun" : "fas fa-moon";

        showNotification(`Switched to ${newTheme} theme`, "success");
      }

      function toggleFullscreen() {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen();
        } else {
          document.exitFullscreen();
        }
      }

      function handleStartStopClick() {
        const btn = document.getElementById("start-stop-btn");
        const icon = btn.querySelector("i");

        if (btn.textContent.trim().includes("Start")) {
          // Start dorking
          showConfigModal();
        } else {
          // Stop dorking
          stopDorking();
        }
      }

      function exportURLs() {
        if (!sessionData.results || sessionData.results.length === 0) {
          showNotification("‚ö†Ô∏è No results to export", "warning");
          return;
        }

        // Collect all URLs from all results
        const allUrls = [];
        sessionData.results.forEach((result) => {
          if (result.results && Array.isArray(result.results)) {
            result.results.forEach((url) => {
              if (url.url) {
                allUrls.push(url.url);
              }
            });
          }
        });

        if (allUrls.length === 0) {
          showNotification("‚ö†Ô∏è No URLs found to export", "warning");
          return;
        }

        // Show option dialog for export type
        const includeDuplicates = confirm(
          `Found ${allUrls.length} total URLs.\n\n` +
            `Click OK to export ALL URLs (including duplicates)\n` +
            `Click Cancel to export only UNIQUE URLs\n\n` +
            `Unique count: ${[...new Set(allUrls)].length}\n` +
            `Total count: ${allUrls.length}\n` +
            `Duplicates: ${allUrls.length - [...new Set(allUrls)].length}`
        );

        let urlsToExport;
        let exportType;

        if (includeDuplicates) {
          urlsToExport = allUrls;
          exportType = "all";
        } else {
          urlsToExport = [...new Set(allUrls)];
          exportType = "unique";
        }

        // Create and download file
        const urlsText = urlsToExport.join("\n");
        const blob = new Blob([urlsText], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        
        // Create timestamp for filename
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T');
        const dateStr = timestamp[0]; // YYYY-MM-DD
        const timeStr = timestamp[1].split('.')[0]; // HH-MM-SS
        
        a.href = url;
        a.download = `threatdorker-urls_${dateStr}_${timeStr}-${exportType}.txt`;
        a.click();
        URL.revokeObjectURL(url);

        const duplicateInfo = includeDuplicates
          ? ` (including ${
              allUrls.length - [...new Set(allUrls)].length
            } duplicates)`
          : ` (duplicates removed)`;

        showNotification(
          `üìé Exported ${urlsToExport.length} ${exportType} URLs${duplicateInfo}`,
          "success"
        );
        console.log(
          `üìé Exported ${urlsToExport.length} ${exportType} URLs to file`
        );
      }

      function exportData() {
        document.getElementById("export-modal").classList.add("show");
      }

      function closeModal() {
        document.getElementById("export-modal").classList.remove("show");
      }

      function performExport() {
        const exportResults = document.getElementById("export-results").checked;
        const exportLogs = document.getElementById("export-logs").checked;
        const exportStats = document.getElementById("export-stats").checked;

        const data = {};

        if (exportResults) data.results = sessionData.results;
        if (exportLogs) data.logs = sessionData.logs;
        if (exportStats) data.stats = sessionData.stats;

        // Download as JSON
        const blob = new Blob([JSON.stringify(data, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        
        // Create timestamp for filename
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T');
        const dateStr = timestamp[0]; // YYYY-MM-DD
        const timeStr = timestamp[1].split('.')[0]; // HH-MM-SS
        
        a.href = url;
        a.download = `threatdorker-export_${dateStr}_${timeStr}.json`;
        a.click();
        URL.revokeObjectURL(url);

        closeModal();
        showNotification("Data exported successfully", "success");
      }

      function clearResults() {
        const container = document.getElementById("results-container");
        container.innerHTML = `
          <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
            <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <div>Waiting for results...</div>
          </div>
        `;
        sessionData.results = [];
        showNotification("Results cleared", "success");
      }

      function clearLogs() {
        const container = document.getElementById("logs-container");
        container.innerHTML = `
          <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
            <i class="fas fa-terminal" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <div>Waiting for system logs...</div>
          </div>
        `;
        sessionData.logs = [];
        showNotification("Logs cleared", "success");
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Server Mode Functions
      async function checkServerMode() {
        try {
          const response = await fetch("/api/server-mode");
          const data = await response.json();

          if (data.enabled) {
            setupServerModeUI(data);
          }
        } catch (error) {
          console.log("Server mode not available or error:", error);
        }
      }

      function setupServerModeUI(serverModeData) {
        const startStopBtn = document.getElementById("start-stop-btn");
        const exportUrlsBtn = document.getElementById("export-urls-btn");

        // Show start/stop button
        startStopBtn.style.display = "inline-flex";

        // Check if server mode and can start
        if (serverModeData.canStart) {
          startStopBtn.innerHTML = '<i class="fas fa-play"></i> Start';
          startStopBtn.className = "btn btn-primary";
        }

        // Update for running state
        if (serverModeData.status === "running") {
          startStopBtn.innerHTML = '<i class="fas fa-stop"></i> Stop';
          startStopBtn.className = "btn";
          startStopBtn.style.borderColor = "var(--error-color)";
          startStopBtn.style.color = "var(--error-color)";
          exportUrlsBtn.style.display = "inline-flex";
        }

        // Show server mode indicator
        showNotification(
          "üåê Server mode active - enhanced controls available",
          "info"
        );
      }

      function showConfigModal() {
        // Ensure completion popup is hidden when showing config modal
        closeCompletionPopup();
        document.getElementById("config-modal").classList.add("show");
      }

      function closeConfigModal() {
        const configModal = document.getElementById("config-modal");
        configModal.classList.remove("show");

        console.log("‚öôÔ∏è Configuration modal closed");
      }

      async function startDorkingWithConfig() {
        const form = document.getElementById("config-form");
        const formData = new FormData(form);

        const minDelay = parseInt(formData.get("minDelay"));
        const maxDelay = parseInt(formData.get("maxDelay"));

        // Validate delay range
        if (maxDelay <= minDelay) {
          showNotification(
            "Maximum delay must be greater than minimum delay",
            "error"
          );
          return;
        }

        const config = {
          dorkFile: formData.get("dorkFile"),
          outputFile: formData.get("outputFile"),
          resultCount: parseInt(formData.get("resultCount")),
          maxPages: parseInt(formData.get("maxPages")) || 1,
          minDelay: minDelay,
          maxDelay: maxDelay,
          maxPause: parseInt(formData.get("maxPause")),
          headless: formData.get("headless") === "on",
          userAgent: formData.get("userAgent") || null,
          manualCaptchaMode: formData.get("manualCaptchaMode") === "on",
          humanLike: formData.get("humanLike") === "on",
          autoProxy: formData.get("autoProxy") === "on",
          multiEngine: formData.get("multiEngine") === "on",
          dorkFiltering: formData.get("dorkFiltering") === "on",
          verbose: true,
        };

        // Collect selected search engines if multi-engine is enabled
        let engines = ['google']; // Default to Google
        if (config.multiEngine) {
          const selectedEngines = [];
          const engineCheckboxes = document.querySelectorAll('input[name="searchEngine"]:checked');
          engineCheckboxes.forEach(cb => selectedEngines.push(cb.value));
          
          if (selectedEngines.length === 0) {
            showNotification("Please select at least one search engine", "error");
            document.getElementById("config-modal").classList.add("show");
            return;
          }
          engines = selectedEngines;
        }
        
        config.engines = engines;

        // IMMEDIATELY close the modal before making the request
        const configModal = document.getElementById("config-modal");
        configModal.classList.remove("show");

        // Prepare UI for live stats immediately
        initializeLiveStatsDisplay();

        // IMMEDIATELY update button to "Stop" state when starting
        updateUIForRunningState();

        try {
          showNotification("üöÄ Starting dorking session...", "info");

          const response = await fetch("/api/start-dorking", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(config),
          });

          const result = await response.json();

          if (result.success) {
            showNotification(
              "‚úÖ Dorking session started successfully!",
              "success"
            );

            // UI already updated above
          } else {
            showNotification(
              `‚ùå Failed to start dorking: ${result.error}`,
              "error"
            );
            // Revert button back to "Start" state on failure
            revertButtonToStartState();
            // Re-show modal if there was an error
            configModal.classList.add("show");
          }
        } catch (error) {
          showNotification(
            `‚ùå Error starting dorking: ${error.message}`,
            "error"
          );
          // Revert button back to "Start" state on error
          revertButtonToStartState();
          // Re-show modal if there was an error
          configModal.classList.add("show");
        }
      }

      // Initialize the UI for live stats display
      function initializeLiveStatsDisplay() {
        // Ensure completion popup is hidden if it's open
        closeCompletionPopup();

        // Reset all stats to show "0" but make them visible
        document.getElementById("progress-percentage").textContent = "0%";
        document.getElementById("processed-count").textContent = "0";
        document.getElementById("total-count").textContent = "0";
        document.getElementById("success-rate").textContent = "0%";
        document.getElementById("successful-count").textContent = "0";
        document.getElementById("total-results").textContent = "0";
        document.getElementById("avg-results").textContent = "0";
        document.getElementById("captcha-encounters").textContent = "0";
        document.getElementById("captcha-solved").textContent = "0";
        document.getElementById("captcha-rate").innerHTML =
          "<span>0%</span> solve rate";

        // Set status to "initializing"
        updateStatus("initializing", "Preparing to start dorking session...");

        // Reset progress ring
        updateProgressRing(0);

        // Keep existing results and logs visible until session actually starts
        // They will be cleared when sessionStart event is received
        console.log(
          "üí° Keeping existing results visible until session starts..."
        );

        // Reset performance chart
        if (performanceChart) {
          performanceChart.data.labels = [];
          performanceChart.data.datasets[0].data = [];
          performanceChart.update();
        }

        // Reset session data
        sessionData = {
          results: [],
          logs: [],
          stats: {},
          performanceData: [],
        };

        // Set current dork to waiting state
        document.getElementById("current-dork").textContent =
          "Initializing session...";
        document.getElementById("current-proxy").textContent = "None";
        document.getElementById("start-time").textContent = "Starting...";
        document.getElementById("runtime").textContent = "00:00:00";

        console.log(
          "üéØ Live stats display initialized - ready for real-time updates"
        );
      }

      // Update UI elements for running state
      function updateUIForRunningState() {
        const startStopBtn = document.getElementById("start-stop-btn");
        const exportUrlsBtn = document.getElementById("export-urls-btn");

        // Update start/stop button to stop mode
        if (startStopBtn) {
          startStopBtn.innerHTML = '<i class="fas fa-stop"></i> Stop';
          startStopBtn.className = "btn";
          startStopBtn.style.borderColor = "var(--error-color)";
          startStopBtn.style.color = "var(--error-color)";
          startStopBtn.style.display = "inline-flex";
        }

        // Show export URLs button
        if (exportUrlsBtn) {
          exportUrlsBtn.style.display = "inline-flex";
        }

        // Set status to running
        updateStatus("running", "Session active - monitoring progress...");

        console.log("üèÉ UI updated for running state - live stats active");
      }

      // Revert button back to start state (used when start fails)
      function revertButtonToStartState() {
        const startStopBtn = document.getElementById("start-stop-btn");
        if (startStopBtn) {
          startStopBtn.innerHTML = '<i class="fas fa-play"></i> Start';
          startStopBtn.className = "btn btn-primary";
          startStopBtn.style.borderColor = "";
          startStopBtn.style.color = "";
          startStopBtn.style.display = "inline-flex";

          console.log("üîÑ Button reverted back to Start state due to error");
        }

        // Update status back to idle
        updateStatus("idle", "Ready to start dorking session");
      }

      async function stopDorking() {
        try {
          showNotification("üõë Stopping dorking session...", "info");
          console.log("üõë Stop request initiated");

          const response = await fetch("/api/stop-dorking", {
            method: "POST",
          });

          const result = await response.json();

          if (result.success) {
            showNotification(
              "‚úÖ Dorking session stopped successfully",
              "success"
            );

            // Update UI back to start mode immediately
            const startStopBtn = document.getElementById("start-stop-btn");
            if (startStopBtn) {
              startStopBtn.innerHTML = '<i class="fas fa-play"></i> Start';
              startStopBtn.className = "btn btn-primary";
              startStopBtn.style.borderColor = "";
              startStopBtn.style.color = "";
              startStopBtn.style.display = "inline-flex";

              console.log("üîÑ Manual stop: Button changed back to Start mode");
            }

            // Stop runtime timer
            if (runtimeInterval) {
              clearInterval(runtimeInterval);
              runtimeInterval = null;
            }

            // Update status to idle
            updateStatus("idle", "Session stopped - ready for next run");

            // Keep export URLs button visible if there are results
            const exportUrlsBtn = document.getElementById("export-urls-btn");
            if (
              exportUrlsBtn &&
              sessionData.results &&
              sessionData.results.length > 0
            ) {
              exportUrlsBtn.style.display = "inline-flex";
              console.log("üìé Export URLs button kept visible after stop");
            }

            console.log("üõë Manual stop completed successfully");
          } else {
            showNotification(
              `‚ùå Failed to stop dorking: ${result.error}`,
              "error"
            );
          }
        } catch (error) {
          showNotification(
            `‚ùå Error stopping dorking: ${error.message}`,
            "error"
          );
          console.error("üõë Stop error:", error);
        }
      }
    </script>
  </body>
</html>
