<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DORKER - Advanced Dashboard</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --bg-primary: #ffffff;
        --bg-secondary: #f8fafc;
        --bg-tertiary: #f1f5f9;
        --text-primary: #0f172a;
        --text-secondary: #64748b;
        --text-accent: #3b82f6;
        --border-color: #e2e8f0;
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --error-color: #ef4444;
        --glass-bg: rgba(255, 255, 255, 0.8);
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        --radius: 12px;
        --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }

      [data-theme="dark"] {
        --bg-primary: #0f172a;
        --bg-secondary: #1e293b;
        --bg-tertiary: #334155;
        --text-primary: #f8fafc;
        --text-secondary: #94a3b8;
        --text-accent: #60a5fa;
        --border-color: #334155;
        --glass-bg: rgba(15, 23, 42, 0.8);
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        overflow-x: hidden;
        min-height: 100vh;
        transition: var(--transition);
      }

      /* Header */
      .header {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--border-color);
        padding: 1rem 2rem;
        position: sticky;
        top: 0;
        z-index: 1000;
      }

      .header-content {
        max-width: 1600px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .logo h1 {
        font-size: 1.5rem;
        font-weight: 700;
        background: linear-gradient(
          135deg,
          var(--text-primary),
          var(--text-accent)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .header-controls {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .btn {
        padding: 0.5rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-primary);
        color: var(--text-primary);
        cursor: pointer;
        transition: var(--transition);
        font-size: 0.875rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn:hover {
        background: var(--bg-secondary);
        transform: translateY(-1px);
      }

      .btn-primary {
        background: var(--text-accent);
        color: white;
        border-color: var(--text-accent);
      }

      .detailed-status {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.25rem;
      }

      .status-pill {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        transition: all 0.3s ease;
      }

      .status-details {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-align: right;
        max-width: 200px;
        word-wrap: break-word;
        line-height: 1.2;
      }

      .status-idle {
        background: var(--bg-tertiary);
        color: var(--text-secondary);
      }

      .status-initializing {
        background: linear-gradient(45deg, #3b82f6, #06b6d4);
        color: white;
        animation: statusPulse 2s infinite;
      }

      .status-warming-up {
        background: linear-gradient(45deg, #f59e0b, #eab308);
        color: white;
        animation: statusPulse 1.5s infinite;
      }

      .status-searching {
        background: linear-gradient(45deg, #10b981, #059669);
        color: white;
        animation: statusPulse 2s infinite;
      }

      .status-captcha {
        background: linear-gradient(45deg, #ef4444, #dc2626);
        color: white;
        animation: statusPulse 1s infinite;
      }

      .status-running {
        background: var(--text-accent);
        color: white;
        animation: pulse 2s infinite;
      }

      .status-completed {
        background: var(--success-color);
        color: white;
      }

      .status-error {
        background: var(--error-color);
        color: white;
      }

      /* Main Layout */
      .container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 2rem;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .card {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        padding: 1.5rem;
        box-shadow: var(--shadow-sm);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
      }

      .card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .card-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .card-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        font-variant-numeric: tabular-nums;
      }

      .card-trend {
        font-size: 0.75rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.25rem;
      }

      .trend-up {
        color: var(--success-color);
      }

      .trend-down {
        color: var(--error-color);
      }

      /* Charts */
      .chart-container {
        position: relative;
        height: 200px;
        margin-top: 1rem;
      }

      /* Wide sections */
      .wide-section {
        grid-column: 1 / -1;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .section-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      /* Progress */
      .progress-ring {
        width: 60px;
        height: 60px;
        transform: rotate(-90deg);
      }

      .progress-ring-circle {
        fill: none;
        stroke: var(--bg-tertiary);
        stroke-width: 4;
      }

      .progress-ring-progress {
        fill: none;
        stroke: var(--text-accent);
        stroke-width: 4;
        stroke-linecap: round;
        transition: stroke-dasharray 0.5s ease;
      }

      /* Data table */
      .data-table {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        overflow: hidden;
      }

      .table-header {
        background: var(--bg-secondary);
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .table-content {
        max-height: 400px;
        overflow-y: auto;
      }

      .table-row {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        transition: var(--transition);
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        gap: 1rem;
      }

      .table-row:hover {
        background: var(--bg-secondary);
      }

      .table-row:last-child {
        border-bottom: none;
      }

      /* Notifications */
      .notification {
        position: fixed;
        top: 5rem;
        right: 2rem;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        padding: 1rem;
        box-shadow: var(--shadow-lg);
        max-width: 400px;
        z-index: 2000;
        transform: translateX(100%);
        transition: transform 0.3s ease;
      }

      .notification.show {
        transform: translateX(0);
      }

      .notification-success {
        border-left: 4px solid var(--success-color);
      }

      .notification-warning {
        border-left: 4px solid var(--warning-color);
      }

      .notification-error {
        border-left: 4px solid var(--error-color);
      }

      /* Logs */
      .log-entry {
        font-family: "JetBrains Mono", monospace;
        font-size: 0.8rem;
        padding: 0.75rem;
        border-bottom: 1px solid var(--border-color);
        display: grid;
        grid-template-columns: auto auto 1fr;
        gap: 1rem;
        align-items: start;
      }

      .log-time {
        color: var(--text-secondary);
        font-weight: 500;
      }

      .log-level {
        padding: 0.125rem 0.5rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .log-level.info {
        background: var(--text-accent);
        color: white;
      }

      .log-level.success {
        background: var(--success-color);
        color: white;
      }

      .log-level.warning {
        background: var(--warning-color);
        color: white;
      }

      .log-level.error {
        background: var(--error-color);
        color: white;
      }

      .log-message {
        color: var(--text-primary);
        line-height: 1.4;
        word-break: break-word;
      }

      .important-log {
        background: var(--bg-secondary);
        border-left: 3px solid var(--text-accent);
      }

      .important-log .log-message {
        font-weight: 500;
      }

      /* Live Status Section */
      .status-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .main-status {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: var(--bg-secondary);
        border-radius: 12px;
        border: 2px solid var(--border-color);
      }

      .main-status-pill {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem 2rem;
        border-radius: 2rem;
        font-size: 1.1rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        transition: all 0.3s ease;
        min-width: 200px;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .main-status-pill i {
        font-size: 1.3rem;
      }

      .main-status-text {
        font-size: 1rem;
        color: var(--text-secondary);
        text-align: center;
        font-weight: 500;
      }

      .status-metrics {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        width: 100%;
      }

      .status-metric {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1rem;
        background: var(--bg-secondary);
        border-radius: 8px;
        border: 1px solid var(--border-color);
        transition: var(--transition);
      }

      .status-metric:hover {
        background: var(--bg-tertiary);
        transform: translateY(-2px);
      }

      .metric-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
        font-weight: 600;
      }

      .metric-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
        font-variant-numeric: tabular-nums;
      }

      /* Enhanced status pill variants */
      .main-status-pill.status-idle {
        background: linear-gradient(135deg, #6b7280, #9ca3af);
        color: white;
      }

      .main-status-pill.status-initializing {
        background: linear-gradient(135deg, #3b82f6, #06b6d4);
        color: white;
        animation: statusPulse 2s infinite;
      }

      .main-status-pill.status-warming-up {
        background: linear-gradient(135deg, #f59e0b, #eab308);
        color: white;
        animation: statusPulse 1.5s infinite;
      }

      .main-status-pill.status-searching {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        animation: statusPulse 2s infinite;
      }

      .main-status-pill.status-captcha {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        animation: statusPulse 1s infinite;
      }

      .main-status-pill.status-running {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        animation: statusPulse 2s infinite;
      }

      .main-status-pill.status-completed {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        color: white;
      }

      .main-status-pill.status-error {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
      }

      @media (max-width: 768px) {
        .status-metrics {
          grid-template-columns: 1fr;
        }

        .main-status-pill {
          min-width: 150px;
          padding: 0.75rem 1.5rem;
          font-size: 1rem;
        }
      }

      /* Results */
      .result-card {
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid var(--border-color);
      }

      .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
      }

      .result-dork {
        font-family: "JetBrains Mono", monospace;
        font-size: 0.875rem;
        color: var(--text-primary);
        word-break: break-all;
        flex: 1;
      }

      .result-count {
        background: var(--text-accent);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .result-urls {
        display: grid;
        gap: 0.5rem;
      }

      .result-url-container {
        background: var(--bg-primary);
        border-radius: 6px;
        border: 1px solid var(--border-color);
        padding: 0.75rem;
        transition: var(--transition);
      }

      .result-url-container:hover {
        background: var(--bg-tertiary);
        transform: translateX(4px);
      }

      .result-url-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
        word-break: break-word;
      }

      .result-url {
        color: var(--text-accent);
        text-decoration: none;
        font-size: 0.75rem;
        display: block;
        word-break: break-all;
        font-family: "JetBrains Mono", monospace;
        line-height: 1.4;
      }

      .result-url:hover {
        text-decoration: underline;
      }

      /* Animation */
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.8;
          transform: scale(1.05);
        }
      }

      /* Live stats animations */
      .live-update {
        animation: liveUpdate 0.5s ease-in-out;
      }

      @keyframes liveUpdate {
        0% {
          background-color: rgba(59, 130, 246, 0.1);
        }
        50% {
          background-color: rgba(59, 130, 246, 0.2);
        }
        100% {
          background-color: transparent;
        }
      }

      .status-pulse {
        animation: statusPulse 2s infinite;
      }

      @keyframes statusPulse {
        0%,
        100% {
          box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4);
        }
        50% {
          box-shadow: 0 0 0 8px rgba(34, 197, 94, 0);
        }
      }

      .live-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--success-color);
        font-size: 0.75rem;
        font-weight: 600;
      }

      .live-dot {
        width: 6px;
        height: 6px;
        background: var(--success-color);
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      /* Modal */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 3000;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transition: opacity 0.3s ease, visibility 0.3s ease,
          pointer-events 0.3s ease;
      }

      .modal.show {
        opacity: 1;
        visibility: visible;
        pointer-events: all;
      }

      .modal-content {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        box-shadow: var(--shadow-lg);
        transform: scale(0.95);
        transition: var(--transition);
      }

      .modal.show .modal-content {
        transform: scale(1);
      }

      .modal-header {
        margin-bottom: 1.5rem;
      }

      .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      .modal-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 2rem;
      }

      /* Responsive */
      @media (max-width: 1024px) {
        .dashboard-grid {
          grid-template-columns: 1fr 1fr;
        }
      }

      @media (max-width: 768px) {
        .header {
          padding: 1rem;
        }

        .container {
          padding: 1rem;
        }

        .dashboard-grid {
          grid-template-columns: 1fr;
          gap: 1rem;
        }

        .header-content {
          flex-direction: column;
          gap: 1rem;
        }

        .log-entry {
          grid-template-columns: 1fr;
          gap: 0.5rem;
        }
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }

      ::-webkit-scrollbar-track {
        background: var(--bg-tertiary);
      }

      ::-webkit-scrollbar-thumb {
        background: var(--text-secondary);
        border-radius: 3px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: var(--text-primary);
      }

      /* Remove duplicate modal CSS - keeping the one above */

      .modal-content {
        background: var(--bg-primary);
        border-radius: var(--radius);
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        box-shadow: var(--shadow-lg);
      }

      .modal-header {
        margin-bottom: 1.5rem;
      }

      .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      .modal-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 1.5rem;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <div class="logo">
          <i
            class="fas fa-search"
            style="color: var(--text-accent); font-size: 1.5rem"
          ></i>
          <h1>DORKER</h1>
          <div class="live-indicator">
            <div class="live-dot"></div>
            LIVE
          </div>
        </div>

        <div class="header-controls">
          <div id="detailed-status" class="detailed-status">
            <div id="status-indicator" class="status-pill status-idle">
              Idle
            </div>
            <div id="status-details" class="status-details">Ready to start</div>
          </div>
          <button class="btn" id="start-stop-btn" style="display: none">
            <i class="fas fa-play"></i>
            Start
          </button>
          <button
            class="btn btn-primary"
            id="export-urls-btn"
            style="display: none"
          >
            <i class="fas fa-link"></i>
            Export URLs
          </button>
          <button class="btn" id="theme-toggle-btn">
            <i class="fas fa-moon" id="theme-icon"></i>
          </button>
          <button class="btn" id="fullscreen-toggle-btn">
            <i class="fas fa-expand"></i>
          </button>
          <button class="btn btn-primary" id="export-data-btn">
            <i class="fas fa-download"></i>
            Export All
          </button>
        </div>
      </div>
    </header>

    <!-- Main Dashboard -->
    <div class="container">
      <!-- Stats Grid -->
      <div class="dashboard-grid">
        <!-- Progress Card -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Progress</div>
            <svg class="progress-ring" width="60" height="60">
              <circle
                class="progress-ring-circle"
                cx="30"
                cy="30"
                r="26"
              ></circle>
              <circle
                class="progress-ring-progress"
                cx="30"
                cy="30"
                r="26"
                id="progress-circle"
              ></circle>
            </svg>
          </div>
          <div class="card-value" id="progress-percentage">0%</div>
          <div class="card-trend" id="progress-trend">
            <span id="processed-count">0</span> /
            <span id="total-count">0</span> dorks
          </div>
        </div>

        <!-- Success Rate -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Success Rate</div>
            <i
              class="fas fa-chart-line"
              style="color: var(--success-color)"
            ></i>
          </div>
          <div class="card-value" id="success-rate">0%</div>
          <div class="card-trend trend-up" id="success-trend">
            <i class="fas fa-arrow-up"></i>
            <span id="successful-count">0</span> successful
          </div>
        </div>

        <!-- Results Found -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Results Found</div>
            <i class="fas fa-database" style="color: var(--text-accent)"></i>
          </div>
          <div class="card-value" id="total-results">0</div>
          <div class="card-trend" id="results-trend">
            <span id="avg-results">0</span> avg per dork
          </div>
        </div>

        <!-- Performance Chart -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Performance</div>
            <i
              class="fas fa-tachometer-alt"
              style="color: var(--warning-color)"
            ></i>
          </div>
          <div class="chart-container">
            <canvas id="performanceChart"></canvas>
          </div>
        </div>

        <!-- Security Stats -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Security</div>
            <i class="fas fa-shield-alt" style="color: var(--error-color)"></i>
          </div>
          <div
            style="
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 1rem;
              margin-top: 1rem;
            "
          >
            <div>
              <div
                style="font-size: 1.5rem; font-weight: 700"
                id="captcha-encounters"
              >
                0
              </div>
              <div style="font-size: 0.75rem; color: var(--text-secondary)">
                CAPTCHAs
              </div>
            </div>
            <div>
              <div
                style="font-size: 1.5rem; font-weight: 700"
                id="captcha-solved"
              >
                0
              </div>
              <div style="font-size: 0.75rem; color: var(--text-secondary)">
                Solved
              </div>
            </div>
          </div>
          <div class="card-trend" id="captcha-rate" style="margin-top: 0.5rem">
            <span>0%</span> solve rate
          </div>
        </div>

        <!-- Runtime Info -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Session</div>
            <i class="fas fa-clock" style="color: var(--text-secondary)"></i>
          </div>
          <div style="margin-top: 1rem">
            <div style="margin-bottom: 0.5rem">
              <span style="color: var(--text-secondary); font-size: 0.875rem"
                >Runtime:</span
              >
              <span style="font-weight: 600" id="runtime">00:00:00</span>
            </div>
            <div style="margin-bottom: 0.5rem">
              <span style="color: var(--text-secondary); font-size: 0.875rem"
                >Started:</span
              >
              <span style="font-weight: 600" id="start-time">-</span>
            </div>
            <div>
              <span style="color: var(--text-secondary); font-size: 0.875rem"
                >Proxy:</span
              >
              <span style="font-weight: 600" id="current-proxy">None</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Live Status Section -->
      <div class="card wide-section">
        <div class="section-header">
          <div class="section-title">
            <i class="fas fa-heartbeat"></i>
            Live Status
          </div>
          <div class="live-indicator">
            <div class="live-dot"></div>
            LIVE
          </div>
        </div>
        <div class="status-container">
          <div class="main-status">
            <div id="main-status-pill" class="main-status-pill status-idle">
              <i class="fas fa-pause-circle"></i>
              <span>Idle</span>
            </div>
            <div id="main-status-text" class="main-status-text">
              Ready to start dorking session
            </div>
          </div>
          <div class="status-metrics">
            <div class="status-metric">
              <span class="metric-label">Progress</span>
              <span class="metric-value" id="live-progress">0 / 0</span>
            </div>
            <div class="status-metric">
              <span class="metric-label">Results</span>
              <span class="metric-value" id="live-results">0</span>
            </div>
            <div class="status-metric">
              <span class="metric-label">Runtime</span>
              <span class="metric-value" id="live-runtime">00:00:00</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Current Dork -->
      <div class="card wide-section">
        <div class="section-header">
          <div class="section-title">
            <i class="fas fa-search"></i>
            Current Processing
          </div>
          <div class="live-indicator">
            <div class="live-dot"></div>
            LIVE
          </div>
        </div>
        <div
          style="
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            word-break: break-all;
            font-size: 0.875rem;
          "
          id="current-dork"
        >
          No dork currently being processed
        </div>
      </div>

      <!-- Results Feed -->
      <div class="card wide-section">
        <div class="section-header">
          <div class="section-title">
            <i class="fas fa-list"></i>
            Results Feed
          </div>
          <div style="display: flex; gap: 1rem">
            <div class="live-indicator">
              <div class="live-dot"></div>
              LIVE
            </div>
            <button class="btn" id="clear-results-btn">
              <i class="fas fa-trash"></i>
              Clear
            </button>
          </div>
        </div>
        <div class="table-content" id="results-container">
          <div
            style="
              text-align: center;
              padding: 3rem;
              color: var(--text-secondary);
            "
          >
            <i
              class="fas fa-search"
              style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5"
            ></i>
            <div>Waiting for results...</div>
          </div>
        </div>
      </div>

      <!-- System Logs -->
      <div class="card wide-section">
        <div class="section-header">
          <div class="section-title">
            <i class="fas fa-terminal"></i>
            System Logs
          </div>
          <div style="display: flex; gap: 1rem">
            <div class="live-indicator">
              <div class="live-dot"></div>
              LIVE
            </div>
            <button class="btn" id="clear-logs-btn">
              <i class="fas fa-trash"></i>
              Clear
            </button>
          </div>
        </div>
        <div class="table-content" id="logs-container">
          <div
            style="
              text-align: center;
              padding: 3rem;
              color: var(--text-secondary);
            "
          >
            <i
              class="fas fa-terminal"
              style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5"
            ></i>
            <div>Waiting for system logs...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Notifications Container -->
    <div id="notifications-container"></div>

    <!-- Configuration Modal -->
    <div class="modal" id="config-modal">
      <div class="modal-content" style="max-width: 600px">
        <div class="modal-header">
          <div class="modal-title">üîß Dorking Configuration</div>
        </div>
        <div style="padding: 1rem">
          <form id="config-form">
            <div style="margin-bottom: 1rem">
              <label
                style="display: block; margin-bottom: 0.5rem; font-weight: 500"
                >üìÅ Dork File Path</label
              >
              <input
                type="text"
                id="dork-file"
                name="dorkFile"
                value="dorks.txt"
                required
                style="
                  width: 100%;
                  padding: 0.5rem;
                  border: 1px solid var(--border-color);
                  border-radius: 6px;
                  background: var(--bg-primary);
                  color: var(--text-primary);
                "
              />
            </div>

            <div style="margin-bottom: 1rem">
              <label
                style="display: block; margin-bottom: 0.5rem; font-weight: 500"
                >üíæ Output File Path</label
              >
              <input
                type="text"
                id="output-file"
                name="outputFile"
                value="results.json"
                required
                style="
                  width: 100%;
                  padding: 0.5rem;
                  border: 1px solid var(--border-color);
                  border-radius: 6px;
                  background: var(--bg-primary);
                  color: var(--text-primary);
                "
              />
            </div>

            <div style="margin-bottom: 1rem">
              <label
                style="display: block; margin-bottom: 0.5rem; font-weight: 500"
                >üìä Results per Search</label
              >
              <input
                type="number"
                id="result-count"
                name="resultCount"
                value="30"
                min="1"
                max="100"
                required
                style="
                  width: 100%;
                  padding: 0.5rem;
                  border: 1px solid var(--border-color);
                  border-radius: 6px;
                  background: var(--bg-primary);
                  color: var(--text-primary);
                "
              />
            </div>

            <div style="margin-bottom: 1rem">
              <label
                style="display: block; margin-bottom: 0.5rem; font-weight: 500"
                >‚è±Ô∏è Minimum Delay between Searches (seconds)</label
              >
              <input
                type="number"
                id="min-delay"
                name="minDelay"
                value="10"
                min="5"
                max="60"
                required
                style="
                  width: 100%;
                  padding: 0.5rem;
                  border: 1px solid var(--border-color);
                  border-radius: 6px;
                  background: var(--bg-primary);
                  color: var(--text-primary);
                "
              />
            </div>

            <div style="margin-bottom: 1rem">
              <label
                style="display: block; margin-bottom: 0.5rem; font-weight: 500"
                >‚è∞ Maximum Delay between Searches (seconds)</label
              >
              <input
                type="number"
                id="max-delay"
                name="maxDelay"
                value="45"
                min="5"
                max="120"
                required
                style="
                  width: 100%;
                  padding: 0.5rem;
                  border: 1px solid var(--border-color);
                  border-radius: 6px;
                  background: var(--bg-primary);
                  color: var(--text-primary);
                "
              />
            </div>

            <div style="margin-bottom: 1rem">
              <label
                style="display: block; margin-bottom: 0.5rem; font-weight: 500"
                >‚è∏Ô∏è Maximum Pause Length (seconds)</label
              >
              <input
                type="number"
                id="max-pause"
                name="maxPause"
                value="60"
                min="30"
                max="60"
                required
                style="
                  width: 100%;
                  padding: 0.5rem;
                  border: 1px solid var(--border-color);
                  border-radius: 6px;
                  background: var(--bg-primary);
                  color: var(--text-primary);
                "
              />
            </div>

            <div style="margin-bottom: 1rem">
              <label
                style="display: block; margin-bottom: 0.5rem; font-weight: 500"
                >ü§ñ Custom User Agent (optional)</label
              >
              <input
                type="text"
                id="user-agent"
                name="userAgent"
                placeholder="Leave empty for default browser agent"
                style="
                  width: 100%;
                  padding: 0.5rem;
                  border: 1px solid var(--border-color);
                  border-radius: 6px;
                  background: var(--bg-primary);
                  color: var(--text-primary);
                "
              />
            </div>

            <div style="margin-bottom: 1rem">
              <label style="display: block; margin-bottom: 1rem">
                <input
                  type="checkbox"
                  id="headless-mode"
                  name="headless"
                  style="margin-right: 0.5rem"
                />
                üëÅÔ∏è Run browser in headless mode
              </label>

              <label style="display: block; margin-bottom: 1rem">
                <input
                  type="checkbox"
                  id="manual-captcha"
                  name="manualCaptchaMode"
                  style="margin-right: 0.5rem"
                />
                üîê Enable manual CAPTCHA solving
              </label>

              <label style="display: block; margin-bottom: 1rem">
                <input
                  type="checkbox"
                  id="human-like"
                  name="humanLike"
                  checked
                  style="margin-right: 0.5rem"
                />
                üé≠ Enable human-like behavior simulation
              </label>

              <label style="display: block; margin-bottom: 1rem">
                <input
                  type="checkbox"
                  id="auto-proxy"
                  name="autoProxy"
                  style="margin-right: 0.5rem"
                />
                üåç Enable automatic proxy switching via ASOCKS
              </label>

              <label style="display: block; margin-bottom: 1rem">
                <input
                  type="checkbox"
                  id="multi-engine"
                  name="multiEngine"
                  style="margin-right: 0.5rem"
                />
                üîç Enable multi-engine dorking
              </label>
            </div>
          </form>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn" id="config-cancel-btn">
            Cancel
          </button>
          <button type="button" class="btn btn-primary" id="config-start-btn">
            <i class="fas fa-play"></i>
            Start Dorking
          </button>
        </div>
      </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="export-modal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">Export Data</div>
        </div>
        <div>
          <label style="display: block; margin-bottom: 1rem">
            <input
              type="checkbox"
              id="export-results"
              checked
              style="margin-right: 0.5rem"
            />
            Export Results
          </label>
          <label style="display: block; margin-bottom: 1rem">
            <input
              type="checkbox"
              id="export-logs"
              checked
              style="margin-right: 0.5rem"
            />
            Export Logs
          </label>
          <label style="display: block; margin-bottom: 1rem">
            <input
              type="checkbox"
              id="export-stats"
              checked
              style="margin-right: 0.5rem"
            />
            Export Statistics
          </label>
        </div>
        <div class="modal-actions">
          <button class="btn" id="modal-cancel-btn">Cancel</button>
          <button class="btn btn-primary" id="modal-export-btn">
            <i class="fas fa-download"></i>
            Export
          </button>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      const socket = io();
      let startTime = null;
      let runtimeInterval = null;
      let performanceChart = null;
      let sessionData = {
        results: [],
        logs: [],
        stats: {},
        performanceData: [],
      };

      // Initialize dashboard
      document.addEventListener("DOMContentLoaded", () => {
        initializeCharts();
        setupEventListeners();
        checkServerMode();

        // Load theme preference
        const savedTheme = localStorage.getItem("dashboard-theme") || "light";
        if (savedTheme === "dark") {
          document.documentElement.setAttribute("data-theme", "dark");
          document.getElementById("theme-icon").className = "fas fa-sun";
        }
      });

      // Socket event handlers
      socket.on("connect", () => {
        showNotification("Connected to server", "success");
        console.log("‚úÖ Dashboard connected");
      });

      socket.on("disconnect", () => {
        showNotification("Disconnected from server", "error");
        console.log("‚ùå Dashboard disconnected");
      });

      socket.on("stats", (stats) => {
        updateStats(stats);
        sessionData.stats = stats;

        // Add performance data point
        sessionData.performanceData.push({
          time: new Date(),
          processed: stats.processedDorks,
          successful: stats.successfulDorks,
          results: stats.totalResults,
        });

        updatePerformanceChart();
      });

      socket.on("sessionStart", (stats) => {
        startTime = new Date(stats.startTime);
        sessionData = {
          results: [],
          logs: [],
          stats: stats,
          performanceData: [],
        };

        console.log("üéØ Session started! Live stats now active:", stats);

        // Update all stats immediately with real data
        document.getElementById("progress-percentage").textContent = "0%";
        document.getElementById("processed-count").textContent = "0";
        document.getElementById("total-count").textContent =
          stats.totalDorks || 0;
        document.getElementById("success-rate").textContent = "0%";
        document.getElementById("successful-count").textContent = "0";
        document.getElementById("total-results").textContent = "0";
        document.getElementById("avg-results").textContent = "0";
        document.getElementById("captcha-encounters").textContent = "0";
        document.getElementById("captcha-solved").textContent = "0";
        document.getElementById("captcha-rate").innerHTML =
          "<span>0%</span> solve rate";

        // Update status and progress
        updateStatus(stats.status || "running");
        updateProgressRing(0);

        // Set start time display
        document.getElementById("start-time").textContent =
          startTime.toLocaleTimeString();
        document.getElementById("runtime").textContent = "00:00:00";

        // Update current session info
        document.getElementById("current-dork").textContent =
          stats.currentDork || "Waiting for first dork...";
        document.getElementById("current-proxy").textContent = stats.proxy
          ? `${stats.proxy.host}:${stats.proxy.port}`
          : "None";

        // Clear and reset containers for live data
        const resultsContainer = document.getElementById("results-container");
        resultsContainer.innerHTML = `
          <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
            <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <div>üîç Session active - waiting for results...</div>
          </div>
        `;

        const logsContainer = document.getElementById("logs-container");
        logsContainer.innerHTML = `
          <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
            <i class="fas fa-terminal" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <div>üìã Session active - waiting for logs...</div>
          </div>
        `;

        // Reset performance chart
        if (performanceChart) {
          performanceChart.data.labels = [];
          performanceChart.data.datasets[0].data = [];
          performanceChart.update();
        }

        // Start runtime timer
        if (runtimeInterval) {
          clearInterval(runtimeInterval);
        }
        runtimeInterval = setInterval(updateRuntime, 1000);

        showNotification(
          "üöÄ Session started - live stats now active!",
          "success"
        );
      });

      socket.on("newResult", (result) => {
        addResult(result);
        sessionData.results.unshift(result);

        // Show notification with more detail
        const dorkPreview =
          result.dork.length > 30
            ? result.dork.substring(0, 30) + "..."
            : result.dork;
        showNotification(
          `üéØ Found ${result.count} results for: ${dorkPreview}`,
          "success"
        );

        console.log("üéØ New result received:", result);
      });

      socket.on("newLog", (log) => {
        addLog(log);
        sessionData.logs.unshift(log);

        // Enhanced status detection from log messages
        const message = log.message.toLowerCase();

        if (message.includes("warming up") || message.includes("warm-up")) {
          updateStatus("warming-up", "Browser warming up session...");
        } else if (
          message.includes("captcha") &&
          message.includes("detected")
        ) {
          updateStatus("captcha", "CAPTCHA challenge detected - solving...");
        } else if (message.includes("captcha") && message.includes("solved")) {
          updateStatus("searching", "CAPTCHA solved - resuming search...");
        } else if (
          message.includes("testing asocks") ||
          message.includes("api connection")
        ) {
          updateStatus("initializing", "Testing proxy connections...");
        } else if (
          message.includes("proxy switch") ||
          message.includes("switching proxy")
        ) {
          updateStatus("initializing", "Switching to new proxy...");
        } else if (
          message.includes("performing search") ||
          message.includes("searching")
        ) {
          updateStatus("searching", "Performing search query...");
        } else if (message.includes("extracting results")) {
          updateStatus("searching", "Extracting search results...");
        } else if (message.includes("delaying") && message.includes("search")) {
          updateStatus("searching", "Waiting between searches...");
        }

        // Show important logs as notifications
        if (log.level === "error") {
          showNotification(`‚ö†Ô∏è ${log.message}`, "warning");
        } else if (
          message.includes("captcha") ||
          message.includes("proxy") ||
          message.includes("warm")
        ) {
          showNotification(`üìã ${log.message}`, "info");
        }

        console.log("üìã New log:", log);
      });

      socket.on("sessionEnd", (data) => {
        console.log("üèÅ Session ended:", data);

        // Clear runtime interval
        if (runtimeInterval) {
          clearInterval(runtimeInterval);
          runtimeInterval = null;
        }

        // Update UI back to idle state
        updateStatus("idle");

        // Show completion notification
        if (data.success) {
          showNotification(
            "‚úÖ Dorking session completed successfully!",
            "success"
          );
        } else {
          showNotification("‚ö†Ô∏è Dorking session ended", "warning");
        }

        // Switch back to start mode
        setTimeout(() => {
          const startStopBtn = document.getElementById("start-stop-btn");
          startStopBtn.innerHTML = '<i class="fas fa-play"></i> Start';
          startStopBtn.className = "btn btn-primary";
          startStopBtn.style.borderColor = "";
          startStopBtn.style.color = "";

          // Keep export URLs button visible if there are results
          const exportUrlsBtn = document.getElementById("export-urls-btn");
          if (sessionData.results && sessionData.results.length > 0) {
            exportUrlsBtn.style.display = "inline-flex";
          }
        }, 1000);
      });

      socket.on("error", (error) => {
        console.error("‚ùå Socket error:", error);
        showNotification(`‚ùå Connection error: ${error.message}`, "error");
      });

      // Update functions - Enhanced for real-time live stats
      function updateStats(stats) {
        console.log("üìä Live stats update:", stats);

        // Progress with live animation
        const progress =
          stats.totalDorks > 0
            ? (stats.processedDorks / stats.totalDorks) * 100
            : 0;
        document.getElementById("progress-percentage").textContent =
          Math.round(progress) + "%";
        document.getElementById("processed-count").textContent =
          stats.processedDorks || 0;
        document.getElementById("total-count").textContent =
          stats.totalDorks || 0;
        updateProgressRing(progress);

        // Success rate with trend indication
        const successRate =
          stats.processedDorks > 0
            ? Math.round((stats.successfulDorks / stats.processedDorks) * 100)
            : 0;
        document.getElementById("success-rate").textContent = successRate + "%";
        document.getElementById("successful-count").textContent =
          stats.successfulDorks || 0;

        // Results metrics
        document.getElementById("total-results").textContent =
          stats.totalResults || 0;
        const avgResults =
          stats.successfulDorks > 0
            ? Math.round(stats.totalResults / stats.successfulDorks)
            : 0;
        document.getElementById("avg-results").textContent = avgResults;

        // Update live status metrics
        const liveProgress = document.getElementById("live-progress");
        const liveResults = document.getElementById("live-results");
        const liveRuntime = document.getElementById("live-runtime");

        if (liveProgress) {
          liveProgress.textContent = `${stats.processedDorks || 0} / ${
            stats.totalDorks || 0
          }`;
        }
        if (liveResults) {
          liveResults.textContent = stats.totalResults || 0;
        }
        if (liveRuntime && startTime) {
          const now = new Date();
          const diff = now - startTime;
          const hours = Math.floor(diff / (1000 * 60 * 60));
          const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((diff % (1000 * 60)) / 1000);
          const runtime = `${hours.toString().padStart(2, "0")}:${minutes
            .toString()
            .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
          liveRuntime.textContent = runtime;
        }

        // Security metrics
        document.getElementById("captcha-encounters").textContent =
          stats.captchaEncounters || 0;
        document.getElementById("captcha-solved").textContent =
          stats.captchaSolved || 0;
        const captchaRate =
          stats.captchaEncounters > 0
            ? Math.round((stats.captchaSolved / stats.captchaEncounters) * 100)
            : 0;
        document.getElementById(
          "captcha-rate"
        ).innerHTML = `<span>${captchaRate}%</span> solve rate`;

        // Live status updates
        updateStatus(stats.status || "running");

        // Current activity - show what's happening right now
        const currentDorkText = stats.currentDork || "Waiting for next dork...";
        document.getElementById("current-dork").textContent = currentDorkText;

        // Proxy information
        const proxyText = stats.proxy
          ? `${stats.proxy.host}:${stats.proxy.port}`
          : "Direct connection";
        document.getElementById("current-proxy").textContent = proxyText;

        // Initialize start time if not set
        if (stats.startTime && !startTime) {
          startTime = new Date(stats.startTime);
          document.getElementById("start-time").textContent =
            startTime.toLocaleTimeString();

          if (!runtimeInterval) {
            runtimeInterval = setInterval(updateRuntime, 1000);
          }
        }

        // Add visual feedback for active updates
        const statusEl = document.getElementById("status-indicator");
        if (statusEl && stats.status === "running") {
          statusEl.style.animation = "pulse 2s infinite";
          setTimeout(() => {
            if (statusEl) statusEl.style.animation = "";
          }, 1000);
        }
      }

      function updateStatus(status, details = null) {
        const statusEl = document.getElementById("status-indicator");
        const detailsEl = document.getElementById("status-details");
        const mainStatusPill = document.getElementById("main-status-pill");
        const mainStatusText = document.getElementById("main-status-text");

        // Update header status pill
        statusEl.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        statusEl.className = `status-pill status-${status.replace(
          /[^a-z-]/gi,
          ""
        )}`;

        // Update main status pill
        const statusIcons = {
          idle: "fas fa-pause-circle",
          initializing: "fas fa-cog fa-spin",
          "warming-up": "fas fa-fire",
          searching: "fas fa-search",
          captcha: "fas fa-lock",
          running: "fas fa-play-circle",
          completed: "fas fa-check-circle",
          error: "fas fa-exclamation-circle",
        };

        const icon = statusIcons[status] || "fas fa-question-circle";
        const cleanStatus = status.replace(/[^a-z-]/gi, "");

        if (mainStatusPill) {
          mainStatusPill.className = `main-status-pill status-${cleanStatus}`;
          mainStatusPill.innerHTML = `
            <i class="${icon}"></i>
            <span>${status.charAt(0).toUpperCase() + status.slice(1)}</span>
          `;
        }

        // Update status details/text
        const statusText = details || getDefaultStatusText(status);
        detailsEl.textContent = statusText;
        if (mainStatusText) {
          mainStatusText.textContent = statusText;
        }

        if (details) {
          detailsEl.style.display = "block";
        }

        console.log(`üîÑ Status updated: ${status} - ${statusText}`);
      }

      function getDefaultStatusText(status) {
        switch (status) {
          case "idle":
            return "Ready to start dorking session";
          case "initializing":
            return "Setting up browser and connections...";
          case "warming-up":
            return "Warming up browser session...";
          case "searching":
            return "Actively searching for results...";
          case "captcha":
            return "Solving CAPTCHA challenge...";
          case "running":
            return "Session active and processing dorks";
          case "completed":
            return "Session completed successfully";
          case "error":
            return "An error occurred during processing";
          default:
            return status;
        }
      }

      function updateProgressRing(progress) {
        const circle = document.getElementById("progress-circle");
        const radius = 26;
        const circumference = 2 * Math.PI * radius;
        const offset = circumference - (progress / 100) * circumference;
        circle.style.strokeDasharray = circumference;
        circle.style.strokeDashoffset = offset;
      }

      function updateRuntime() {
        if (startTime) {
          const now = new Date();
          const diff = now - startTime;
          const hours = Math.floor(diff / (1000 * 60 * 60));
          const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((diff % (1000 * 60)) / 1000);

          const runtime = `${hours.toString().padStart(2, "0")}:${minutes
            .toString()
            .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
          document.getElementById("runtime").textContent = runtime;
        }
      }

      function initializeCharts() {
        try {
          if (typeof Chart === "undefined") {
            console.warn("Chart.js not loaded, skipping chart initialization");
            return;
          }

          const ctx = document
            .getElementById("performanceChart")
            .getContext("2d");
          performanceChart = new Chart(ctx, {
            type: "line",
            data: {
              labels: [],
              datasets: [
                {
                  label: "Results Found",
                  data: [],
                  borderColor: "rgb(59, 130, 246)",
                  backgroundColor: "rgba(59, 130, 246, 0.1)",
                  tension: 0.4,
                  fill: true,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  grid: { color: "rgba(156, 163, 175, 0.2)" },
                  ticks: { color: "rgb(156, 163, 175)" },
                },
                x: {
                  grid: { color: "rgba(156, 163, 175, 0.2)" },
                  ticks: { color: "rgb(156, 163, 175)" },
                },
              },
              plugins: {
                legend: { display: false },
              },
            },
          });
        } catch (error) {
          console.error("Error initializing charts:", error);
        }
      }

      function updatePerformanceChart() {
        if (!performanceChart || sessionData.performanceData.length === 0)
          return;

        const data = sessionData.performanceData.slice(-20); // Last 20 data points

        performanceChart.data.labels = data.map((d) =>
          d.time.toLocaleTimeString()
        );
        performanceChart.data.datasets[0].data = data.map((d) => d.results);
        performanceChart.update("none");
      }

      function addResult(result) {
        const container = document.getElementById("results-container");

        // Remove placeholder
        if (container.querySelector('div[style*="text-align: center"]')) {
          container.innerHTML = "";
        }

        const resultEl = document.createElement("div");
        resultEl.className = "result-card";

        const urlElements = result.results
          .slice(0, 5)
          .map(
            (url) =>
              `<div class="result-url-container">
                 <div class="result-url-title">${escapeHtml(
                   url.title || "No title"
                 )}</div>
                 <a href="${
                   url.url
                 }" target="_blank" class="result-url">${escapeHtml(
                url.url
              )}</a>
               </div>`
          )
          .join("");

        const moreText =
          result.results.length > 5
            ? `<div style="text-align: center; padding: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">... and ${
                result.results.length - 5
              } more results</div>`
            : "";

        resultEl.innerHTML = `
          <div class="result-header">
            <div class="result-dork">${escapeHtml(result.dork)}</div>
            <div class="result-count">${result.count} results</div>
          </div>
          <div class="result-urls">${urlElements}${moreText}</div>
        `;

        container.insertBefore(resultEl, container.firstChild);

        // Keep only last 20 results
        while (container.children.length > 20) {
          container.removeChild(container.lastChild);
        }
      }

      function addLog(log) {
        const container = document.getElementById("logs-container");

        // Remove placeholder
        if (container.querySelector('div[style*="text-align: center"]')) {
          container.innerHTML = "";
        }

        // Filter for important logs
        const isImportantLog = isLogImportant(log);

        const logEl = document.createElement("div");
        logEl.className = isImportantLog
          ? "log-entry important-log"
          : "log-entry";

        const time = new Date(log.timestamp).toLocaleTimeString();

        // Add icons for important log types
        let logIcon = "";
        const message = log.message.toLowerCase();
        if (message.includes("captcha")) {
          logIcon = "üîí ";
        } else if (message.includes("proxy")) {
          logIcon = "üåç ";
        } else if (message.includes("warm")) {
          logIcon = "üî• ";
        } else if (message.includes("search") || message.includes("dork")) {
          logIcon = "üîç ";
        } else if (message.includes("result")) {
          logIcon = "üìä ";
        } else if (log.level === "error") {
          logIcon = "‚ùå ";
        } else if (log.level === "success") {
          logIcon = "‚úÖ ";
        }

        logEl.innerHTML = `
          <span class="log-time">${time}</span>
          <span class="log-level ${log.level}">${log.level}</span>
          <span class="log-message">${logIcon}${escapeHtml(log.message)}</span>
        `;

        container.insertBefore(logEl, container.firstChild);

        // Keep only last 100 logs
        while (container.children.length > 100) {
          container.removeChild(container.lastChild);
        }
      }

      function isLogImportant(log) {
        const message = log.message.toLowerCase();
        const importantKeywords = [
          "captcha",
          "proxy",
          "warm",
          "error",
          "failed",
          "success",
          "completed",
          "started",
          "api",
          "connection",
          "browser",
          "result",
          "found",
          "extracted",
        ];

        return (
          log.level === "error" ||
          log.level === "success" ||
          importantKeywords.some((keyword) => message.includes(keyword))
        );
      }

      function showNotification(message, type = "info") {
        const container = document.getElementById("notifications-container");

        const notification = document.createElement("div");
        notification.className = `notification notification-${type}`;
        const notificationContent = document.createElement("div");
        notificationContent.style.cssText =
          "display: flex; justify-content: space-between; align-items: center;";

        const messageSpan = document.createElement("span");
        messageSpan.textContent = message;

        const closeBtn = document.createElement("button");
        closeBtn.style.cssText =
          "background: none; border: none; cursor: pointer; color: var(--text-secondary);";
        closeBtn.innerHTML = '<i class="fas fa-times"></i>';
        closeBtn.addEventListener("click", () => notification.remove());

        notificationContent.appendChild(messageSpan);
        notificationContent.appendChild(closeBtn);
        notification.appendChild(notificationContent);

        container.appendChild(notification);

        // Show notification
        setTimeout(() => notification.classList.add("show"), 100);

        // Auto remove after 5 seconds
        setTimeout(() => {
          notification.classList.remove("show");
          setTimeout(() => notification.remove(), 300);
        }, 5000);
      }

      function setupEventListeners() {
        socket.emit("requestData");

        // Header control buttons
        document
          .getElementById("start-stop-btn")
          .addEventListener("click", handleStartStopClick);
        document
          .getElementById("export-urls-btn")
          .addEventListener("click", exportURLs);
        document
          .getElementById("theme-toggle-btn")
          .addEventListener("click", toggleTheme);
        document
          .getElementById("fullscreen-toggle-btn")
          .addEventListener("click", toggleFullscreen);
        document
          .getElementById("export-data-btn")
          .addEventListener("click", exportData);

        // Action buttons
        document
          .getElementById("clear-results-btn")
          .addEventListener("click", clearResults);
        document
          .getElementById("clear-logs-btn")
          .addEventListener("click", clearLogs);

        // Modal buttons
        document
          .getElementById("modal-cancel-btn")
          .addEventListener("click", closeModal);
        document
          .getElementById("modal-export-btn")
          .addEventListener("click", performExport);

        // Configuration modal buttons
        document
          .getElementById("config-cancel-btn")
          .addEventListener("click", closeConfigModal);
        document
          .getElementById("config-start-btn")
          .addEventListener("click", startDorkingWithConfig);

        // Close modal when clicking outside
        document
          .getElementById("export-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "export-modal") {
              closeModal();
            }
          });

        document
          .getElementById("config-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "config-modal") {
              closeConfigModal();
            }
          });

        // Heartbeat
        setInterval(() => {
          if (socket.connected) {
            socket.emit("ping");
          }
        }, 30000);
      }

      // UI Functions
      function toggleTheme() {
        const current = document.documentElement.getAttribute("data-theme");
        const newTheme = current === "dark" ? "light" : "dark";

        document.documentElement.setAttribute("data-theme", newTheme);
        localStorage.setItem("dashboard-theme", newTheme);

        const icon = document.getElementById("theme-icon");
        icon.className = newTheme === "dark" ? "fas fa-sun" : "fas fa-moon";

        showNotification(`Switched to ${newTheme} theme`, "success");
      }

      function toggleFullscreen() {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen();
        } else {
          document.exitFullscreen();
        }
      }

      function handleStartStopClick() {
        const btn = document.getElementById("start-stop-btn");
        const icon = btn.querySelector("i");

        if (btn.textContent.trim().includes("Start")) {
          // Start dorking
          showConfigModal();
        } else {
          // Stop dorking
          stopDorking();
        }
      }

      function exportURLs() {
        if (!sessionData.results || sessionData.results.length === 0) {
          showNotification("‚ö†Ô∏è No results to export", "warning");
          return;
        }

        // Collect all URLs from all results
        const allUrls = [];
        sessionData.results.forEach((result) => {
          if (result.results && Array.isArray(result.results)) {
            result.results.forEach((url) => {
              if (url.url) {
                allUrls.push(url.url);
              }
            });
          }
        });

        if (allUrls.length === 0) {
          showNotification("‚ö†Ô∏è No URLs found to export", "warning");
          return;
        }

        // Remove duplicates
        const uniqueUrls = [...new Set(allUrls)];

        // Create and download file
        const urlsText = uniqueUrls.join("\n");
        const blob = new Blob([urlsText], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `dorker-urls-${
          new Date().toISOString().split("T")[0]
        }.txt`;
        a.click();
        URL.revokeObjectURL(url);

        showNotification(
          `üìé Exported ${uniqueUrls.length} unique URLs`,
          "success"
        );
        console.log(`üìé Exported ${uniqueUrls.length} URLs to file`);
      }

      function exportData() {
        document.getElementById("export-modal").classList.add("show");
      }

      function closeModal() {
        document.getElementById("export-modal").classList.remove("show");
      }

      function performExport() {
        const exportResults = document.getElementById("export-results").checked;
        const exportLogs = document.getElementById("export-logs").checked;
        const exportStats = document.getElementById("export-stats").checked;

        const data = {};

        if (exportResults) data.results = sessionData.results;
        if (exportLogs) data.logs = sessionData.logs;
        if (exportStats) data.stats = sessionData.stats;

        // Download as JSON
        const blob = new Blob([JSON.stringify(data, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `dorker-export-${
          new Date().toISOString().split("T")[0]
        }.json`;
        a.click();
        URL.revokeObjectURL(url);

        closeModal();
        showNotification("Data exported successfully", "success");
      }

      function clearResults() {
        const container = document.getElementById("results-container");
        container.innerHTML = `
          <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
            <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <div>Waiting for results...</div>
          </div>
        `;
        sessionData.results = [];
        showNotification("Results cleared", "success");
      }

      function clearLogs() {
        const container = document.getElementById("logs-container");
        container.innerHTML = `
          <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
            <i class="fas fa-terminal" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <div>Waiting for system logs...</div>
          </div>
        `;
        sessionData.logs = [];
        showNotification("Logs cleared", "success");
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Server Mode Functions
      async function checkServerMode() {
        try {
          const response = await fetch("/api/server-mode");
          const data = await response.json();

          if (data.enabled) {
            setupServerModeUI(data);
          }
        } catch (error) {
          console.log("Server mode not available or error:", error);
        }
      }

      function setupServerModeUI(serverModeData) {
        const startStopBtn = document.getElementById("start-stop-btn");
        const exportUrlsBtn = document.getElementById("export-urls-btn");

        // Show start/stop button
        startStopBtn.style.display = "inline-flex";

        // Check if server mode and can start
        if (serverModeData.canStart) {
          startStopBtn.innerHTML = '<i class="fas fa-play"></i> Start';
          startStopBtn.className = "btn btn-primary";
        }

        // Update for running state
        if (serverModeData.status === "running") {
          startStopBtn.innerHTML = '<i class="fas fa-stop"></i> Stop';
          startStopBtn.className = "btn";
          startStopBtn.style.borderColor = "var(--error-color)";
          startStopBtn.style.color = "var(--error-color)";
          exportUrlsBtn.style.display = "inline-flex";
        }

        // Show server mode indicator
        showNotification(
          "üåê Server mode active - enhanced controls available",
          "info"
        );
      }

      function showConfigModal() {
        document.getElementById("config-modal").classList.add("show");
      }

      function closeConfigModal() {
        const configModal = document.getElementById("config-modal");
        configModal.classList.remove("show");

        // Immediately hide the modal for better UX
        configModal.style.opacity = "0";
        configModal.style.visibility = "hidden";
        configModal.style.pointerEvents = "none";

        console.log("‚öôÔ∏è Configuration modal closed");
      }

      async function startDorkingWithConfig() {
        const form = document.getElementById("config-form");
        const formData = new FormData(form);

        const minDelay = parseInt(formData.get("minDelay"));
        const maxDelay = parseInt(formData.get("maxDelay"));

        // Validate delay range
        if (maxDelay <= minDelay) {
          showNotification(
            "Maximum delay must be greater than minimum delay",
            "error"
          );
          return;
        }

        const config = {
          dorkFile: formData.get("dorkFile"),
          outputFile: formData.get("outputFile"),
          resultCount: parseInt(formData.get("resultCount")),
          minDelay: minDelay,
          maxDelay: maxDelay,
          maxPause: parseInt(formData.get("maxPause")),
          headless: formData.get("headless") === "on",
          userAgent: formData.get("userAgent") || null,
          manualCaptchaMode: formData.get("manualCaptchaMode") === "on",
          humanLike: formData.get("humanLike") === "on",
          autoProxy: formData.get("autoProxy") === "on",
          multiEngine: formData.get("multiEngine") === "on",
          verbose: true,
        };

        // IMMEDIATELY close the modal before making the request
        const configModal = document.getElementById("config-modal");
        configModal.classList.remove("show");
        configModal.style.opacity = "0";
        configModal.style.visibility = "hidden";
        configModal.style.pointerEvents = "none";

        // Prepare UI for live stats immediately
        initializeLiveStatsDisplay();

        try {
          showNotification("üöÄ Starting dorking session...", "info");

          const response = await fetch("/api/start-dorking", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(config),
          });

          const result = await response.json();

          if (result.success) {
            showNotification(
              "‚úÖ Dorking session started successfully!",
              "success"
            );

            // Update UI for running state
            updateUIForRunningState();
          } else {
            showNotification(
              `‚ùå Failed to start dorking: ${result.error}`,
              "error"
            );
            // Re-show modal if there was an error
            configModal.classList.add("show");
            configModal.style.opacity = "1";
            configModal.style.visibility = "visible";
            configModal.style.pointerEvents = "all";
          }
        } catch (error) {
          showNotification(
            `‚ùå Error starting dorking: ${error.message}`,
            "error"
          );
          // Re-show modal if there was an error
          configModal.classList.add("show");
          configModal.style.opacity = "1";
          configModal.style.visibility = "visible";
          configModal.style.pointerEvents = "all";
        }
      }

      // Initialize the UI for live stats display
      function initializeLiveStatsDisplay() {
        // Reset all stats to show "0" but make them visible
        document.getElementById("progress-percentage").textContent = "0%";
        document.getElementById("processed-count").textContent = "0";
        document.getElementById("total-count").textContent = "0";
        document.getElementById("success-rate").textContent = "0%";
        document.getElementById("successful-count").textContent = "0";
        document.getElementById("total-results").textContent = "0";
        document.getElementById("avg-results").textContent = "0";
        document.getElementById("captcha-encounters").textContent = "0";
        document.getElementById("captcha-solved").textContent = "0";
        document.getElementById("captcha-rate").innerHTML =
          "<span>0%</span> solve rate";

        // Set status to "initializing"
        updateStatus("initializing", "Preparing to start dorking session...");

        // Reset progress ring
        updateProgressRing(0);

        // Clear results and logs containers but show "waiting" state
        const resultsContainer = document.getElementById("results-container");
        resultsContainer.innerHTML = `
          <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
            <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <div>üîç Session starting... waiting for results...</div>
          </div>
        `;

        const logsContainer = document.getElementById("logs-container");
        logsContainer.innerHTML = `
          <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
            <i class="fas fa-terminal" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <div>üìã Session starting... waiting for logs...</div>
          </div>
        `;

        // Reset performance chart
        if (performanceChart) {
          performanceChart.data.labels = [];
          performanceChart.data.datasets[0].data = [];
          performanceChart.update();
        }

        // Reset session data
        sessionData = {
          results: [],
          logs: [],
          stats: {},
          performanceData: [],
        };

        // Set current dork to waiting state
        document.getElementById("current-dork").textContent =
          "Initializing session...";
        document.getElementById("current-proxy").textContent = "None";
        document.getElementById("start-time").textContent = "Starting...";
        document.getElementById("runtime").textContent = "00:00:00";

        console.log(
          "üéØ Live stats display initialized - ready for real-time updates"
        );
      }

      // Update UI elements for running state
      function updateUIForRunningState() {
        const startStopBtn = document.getElementById("start-stop-btn");
        const exportUrlsBtn = document.getElementById("export-urls-btn");

        // Update start/stop button to stop mode
        startStopBtn.innerHTML = '<i class="fas fa-stop"></i> Stop';
        startStopBtn.className = "btn";
        startStopBtn.style.borderColor = "var(--error-color)";
        startStopBtn.style.color = "var(--error-color)";
        startStopBtn.style.display = "inline-flex";

        // Show export URLs button
        exportUrlsBtn.style.display = "inline-flex";

        // Set status to running
        updateStatus("running", "Session active - monitoring progress...");

        console.log("üèÉ UI updated for running state - live stats active");
      }

      async function stopDorking() {
        try {
          showNotification("Stopping dorking session...", "info");

          const response = await fetch("/api/stop-dorking", {
            method: "POST",
          });

          const result = await response.json();

          if (result.success) {
            showNotification("Dorking session stopped", "success");

            // Remove stop button and add config button
            const stopBtn = document.getElementById("stop-btn");
            if (stopBtn) stopBtn.remove();

            const headerControls = document.querySelector(".header-controls");
            const configBtn = document.createElement("button");
            configBtn.className = "btn btn-primary";
            configBtn.id = "config-btn";
            configBtn.innerHTML =
              '<i class="fas fa-cog"></i> Configure & Start';
            configBtn.addEventListener("click", showConfigModal);
            headerControls.insertBefore(configBtn, headerControls.firstChild);
          } else {
            showNotification(
              `Failed to stop dorking: ${result.error}`,
              "error"
            );
          }
        } catch (error) {
          showNotification(`Error stopping dorking: ${error.message}`, "error");
        }
      }
    </script>
  </body>
</html>
